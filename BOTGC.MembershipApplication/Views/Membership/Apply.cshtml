@model BOTGC.MembershipApplication.Models.MembershipApplication

@{
    ViewData["Title"] = "Application Form";
}

@section Head {
    @await Html.PartialAsync("_GrowSurfScript")
}

<h1 id="membership-form-heading">Application Form</h1>

<section class="membership-intro">
    @if (!String.IsNullOrEmpty(Model.ReferrerId) && !String.IsNullOrEmpty(Model.ReferrerName))
    {
            <div class="referral-banner">
                <h2>
                    Great news – your friend @Model.ReferrerName has recommended you to join us!
                </h2>
                <p>
                    When you become a playing member, both you and @Model.ReferrerName will each receive <strong>£50 credit</strong> in your clubhouse accounts as a thank-you. 
                </p>
                <p class="small text-muted">
                    *Referral reward applies to full, 5-day, 6-day, intermediate, and flexi memberships only.
                </p>
            </div>
    }

    <p>We’re currently welcoming new membership applications with <strong>no joining fee</strong> and <strong>no waiting list</strong>. Whether you’re an experienced golfer, new to the game, or just keen to enjoy the social side of the club, we’d love to hear from you. There’s no need for a proposer or seconder — simply complete the form below to apply.</p>

    <p>Once we receive your application, we’ll invite you to visit the club and meet a member of our membership committee. It’s a relaxed opportunity to explore the facilities, ask questions, and get to know us.</p>

    <p>If your application is successful, we’ll send you your joining instructions and payment details — and that’s it, you’ll be part of the club!</p>

    <p>Not sure which membership is right for you? <a href="#" target="_blank">See our full list of membership options</a> to find the one that suits you best.</p>
</section>


<div id="error-summary" tabindex="-1" class="sr-only" aria-hidden="true">There are validation errors on the form</div>

<form class="membership-form" asp-action="Apply" method="post" novalidate aria-labelledby="membership-form-heading">
    @Html.AntiForgeryToken()

    @Html.HiddenFor(m => m.ReferrerId)
    @Html.HiddenFor(m => m.ReferrerName)
    @Html.HiddenFor(m => m.Fingerprint)

    <div asp-validation-summary="All" role="alert" aria-live="assertive"></div>

    <fieldset>
        <legend class="sr-only">Membership Application Details</legend>

        <div class="form-group">
            <label asp-for="MembershipCategory">Type of Membership<span aria-hidden="true">*</span></label>

            <select asp-for="MembershipCategory" class="form-control" aria-required="true">
                <option value="">Please select a membership type</option>
                <optgroup label="Full Playing Memberships">
                    <option value="7Day">Full Membership</option>
                    <option value="6Day">6 Day Membership – Excludes Saturdays</option>
                    <option value="5Day">5 Day Membership – Weekdays Only</option>
                    <option value="Intermediate">Affordable Membership – Age Restricted</option>
                    <option value="Flexi">Off Peak Playing Membership</option>
                </optgroup>
                <optgroup label="Special Categories">
                    <option value="Junior">Junior Membership</option>
                    <option value="Student">Student Membership</option>
                    <option value="Social">Social Membership – Includes Limited Golf</option>
                    <option value="Clubhouse">Clubhouse Only – No Golf</option>
                    <option value="Family">Family – Relative of Full or Junior Member</option>
                </optgroup>
            </select>

            <span asp-validation-for="MembershipCategory" class="text-danger"></span>

            <div id="membership-description" class="mt-2 text-muted" aria-live="polite"></div>
        </div>

        <div class="form-group">
            <label for="Gender">Gender<span aria-hidden="true">*</span></label>
            <select asp-for="Gender" class="form-control" required aria-required="true">
                <option disabled selected value="">Please select</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
            </select>
            <span class="text-muted" id="genderNote" style="display:none;">
                Please note: To comply with <a href="https://www.randa.org/en/articles/the-r-a-introduces-fair-competition-policy-for-its-professional-and-elite-amateur-championships" target="_blank" rel="noopener noreferrer">R&amp;A guidance on fair competition</a>, we may need to know the gender assigned at birth if you intend to compete in club or county-level events. This information will be handled sensitively and in confidence.
            </span>
        </div>

        <div class="form-group">
            <label asp-for="Title">Title<span aria-hidden="true">*</span></label>
            <select asp-for="Title" required aria-required="true">
                <option disabled selected value="">Please select</option>
                <option>Mr.</option>
                <option>Mrs.</option>
                <option>Ms.</option>
                <option>Miss</option>
                <option>Dr.</option>
            </select>
            <span asp-validation-for="Title"></span>
        </div>

        <div class="form-group">
            <label asp-for="Forename">Forename<span aria-hidden="true">*</span></label>
            <input asp-for="Forename" required aria-required="true" autocomplete="given-name" />
            <span asp-validation-for="Forename"></span>
        </div>

        <div class="form-group">
            <label asp-for="Surname">Surname<span aria-hidden="true">*</span></label>
            <input asp-for="Surname" required aria-required="true" autocomplete="family-name" />
            <span asp-validation-for="Surname"></span>
        </div>

        <div class="form-group">
            <label asp-for="DateOfBirth">Date of Birth<span aria-hidden="true">*</span></label>
            <input asp-for="DateOfBirth" type="date" required aria-required="true" autocomplete="bday" />
            <span asp-validation-for="DateOfBirth"></span>
        </div>

        <div class="form-group">
            <label asp-for="Telephone">Telephone<span aria-hidden="true">*</span></label>
            <input asp-for="Telephone" required aria-required="true" autocomplete="tel" />
            <span asp-validation-for="Telephone"></span>
        </div>

        <div class="form-group">
            <label asp-for="AlternativeTelephone">Alternative Telephone</label>
            <input asp-for="AlternativeTelephone" autocomplete="tel" />
            <span asp-validation-for="AlternativeTelephone"></span>
        </div>

        <div class="form-group">
            <label asp-for="Email">Email Address<span aria-hidden="true">*</span></label>
            <input asp-for="Email" type="email" required aria-required="true" autocomplete="email" aria-describedby="emailHelp" />
            <small id="emailHelp" class="form-text text-muted">We’ll never share your email address.</small>
            <span asp-validation-for="Email"></span>
        </div>

        <div class="form-group">
            <label asp-for="AddressLine1">First Address Line<span aria-hidden="true">*</span></label>
            <input asp-for="AddressLine1" id="AddressLine1" required aria-required="true" autocomplete="address-line1" />
            <small id="address-help" class="form-text text-muted">Start typing your address and select it from the list, or complete the fields manually.</small>
            <span asp-validation-for="AddressLine1"></span>
        </div>

        <div class="form-group">
            <label asp-for="AddressLine2">Second Address Line</label>
            <input asp-for="AddressLine2" id="AddressLine2" autocomplete="address-line2" />
            <span asp-validation-for="AddressLine2"></span>
        </div>

        <div class="form-group">
            <label asp-for="Town">Town / City<span aria-hidden="true">*</span></label>
            <input asp-for="Town" id="Town" required aria-required="true" autocomplete="address-level2" />
            <span asp-validation-for="Town"></span>
        </div>

        <div class="form-group">
            <label asp-for="County">County</label>
            <input asp-for="County" id="County" autocomplete="address-level1" />
            <span asp-validation-for="County"></span>
        </div>

        <div class="form-group">
            <label asp-for="Postcode">Postcode<span aria-hidden="true">*</span></label>
            <input asp-for="Postcode" id="Postcode" required aria-required="true" autocomplete="postal-code" />
            <span asp-validation-for="Postcode"></span>
        </div>

        <div class="form-check flex mb-3">
            <input class="form-check-input" asp-for="HasCdhId" type="checkbox" id="HasCdhId" />
            <label class="form-check-label" for="HasCdhId">
                If you are a golfer with a handicap, you’ll likely have a CDH number. Tick this box to enter it.
            </label>
        </div>

        <div class="form-group" id="cdh-section" style="display:none;">
            <label asp-for="CdhId">CDH ID</label>
            <input asp-for="CdhId" autocomplete="off" />
            <span asp-validation-for="CdhId"></span>
        </div>

        <div class="form-check flex mb-3" id="finance-section" style="display:none;">
            <input class="form-check-input" type="checkbox" id="ArrangeFinance" name="ArrangeFinance" />
            <label class="form-check-label" for="ArrangeFinance">
                Are you looking to arrange finance to pay your subs?
            </label>
        </div>

        <div class="form-check mb-3">
            <input asp-for="AgreeToClubRules" class="form-check-input" type="checkbox" />
            <label class="form-check-label" for="AgreeToClubRules">
                @Html.DisplayNameFor(m => m.AgreeToClubRules)<span aria-hidden="true">*</span>
            </label>
        </div>
        <span asp-validation-for="AgreeToClubRules" class="text-danger"></span>

        <p class="text-muted mt-4">
            By submitting this application, you consent to the processing of your personal data in accordance with our
            <a href="/privacy" target="_blank" rel="noopener">Privacy Policy</a>.
        </p>

        <button id="submit-button" type="submit" aria-busy="false">Submit Application</button>
        <span id="form-loading" class="sr-only" aria-hidden="true">Submitting...</span>
    </fieldset>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://cdn.getaddress.io/scripts/getaddress-autocomplete-3.0.9.js"></script>

    <script>
        $(function () {
            const descriptions = {
                "7Day": "Our Full Membership gives you unrestricted access to the course and all club facilities, seven days a week. You’ll also be eligible to play in all club competitions and enjoy full voting rights as a member.",
                "6Day": "Six Day Membership allows you to play and use the facilities from Sunday to Friday. You can still take part in many competitions and events — just note that play on Saturdays is not included.",
                "5Day": "With a Five Day Membership, you can enjoy access to the course and facilities Monday to Friday. This is ideal for those who prefer to play during quieter weekday periods. Weekend access is not included.",
                "Intermediate": "Our Intermediate (Affordable) Membership is designed to help younger golfers or those new to the game progress toward full membership. It's age-restricted and offers a great value route into the club with increasing access over time.",
                "Flexi": "A flexible membership for occasional golfers who prefer to play at quieter times. Access to the course is limited to off-peak hours and you won’t be eligible for competitions, but it’s a great option for more casual play.",
                "Junior": "Junior Membership is open to younger golfers and includes full access to the course and practice facilities. Juniors are encouraged to get involved with coaching, competitions, and club events to develop their game.",
                "Student": "This membership is for those in full-time education and provides access to the course with some restrictions. It’s a great option for students who want to stay active and play regularly while studying.",
                "Social": "Social Membership gives you access to the clubhouse, social events, and a limited number of golf opportunities. You’ll also benefit from discounted food and drink in the clubhouse and reduced entry fees to club events.",
                "Clubhouse": "Our Clubhouse Membership is for those who want to enjoy the social side of the club — including access to the bar, restaurant, and club events — without using the golf course. Clubhouse members receive discounts on food, drink, and event entry.",
                "Family": "Family Membership provides access to the clubhouse facilities and events for relatives of Full or Junior Members. It’s ideal for those who want to be involved in the club socially and support family members who play. Family members also enjoy discounted food, drink, and entry to club events."
            };

            function updateMembershipDescription() {
                const selectedValue = $('#MembershipCategory').val();
                const $desc = $('#membership-description');
                let description = descriptions[selectedValue] || '';

                const financeEligible = ['7Day', '6Day', '5Day', 'Intermediate'].includes(selectedValue);
                $('#finance-section').toggle(financeEligible);

                // Check if there's a referrer present on the page (hidden field or model)
                const referralEligibleCategories = ['7Day', '6Day', '5Day', 'Intermediate', 'Flexi'];
                const hasReferrer = $('#ReferrerId').val() || false;

                // Append referral reward message if applicable
                if (hasReferrer) {
                    if (referralEligibleCategories.includes(selectedValue)) {
                        description += " <strong>Great news – this category qualifies for our referral reward scheme.</strong>";
                    } else {
                        description += " <strong>Note: This category is not eligible for the referral reward scheme.</strong>";
                    }
                }

                $desc.html(description).toggle(!!selectedValue);
            }

            const enableAutocomplete = async () => {
                await getAddress.autocomplete('AddressLine1', '@ViewData["GetAddressApiKey"]', {
                    selected: (address) => {
                        const line1 = address.formatted_address[0] || ''
                        const line2 = address.formatted_address[1] || ''
                        const townRaw = address.formatted_address[3] || ''
                        const county = address.formatted_address[4] || ''
                        const postcode = address.postcode || ''

                        // Clean and assign line1
                        document.getElementById('AddressLine1').value = line1

                        // Conditional adjustment for line2 and town
                        if (townRaw.includes(',') && !line2) {
                            const [before, after] = townRaw.split(',').map(s => s.trim())
                            document.getElementById('AddressLine2').value = before
                            document.getElementById('Town').value = after
                        } else {
                            document.getElementById('AddressLine2').value = line2
                            document.getElementById('Town').value = townRaw
                        }

                        document.getElementById('County').value = county
                        document.getElementById('Postcode').value = postcode
                    }
                })
            }

            $('#MembershipCategory').on('change', updateMembershipDescription);
            $('#HasCdhId').on('change', function () {
                $('#cdh-section').toggle(this.checked);
            });

            $('form').on('submit', function (e) {
                if (!$(this).valid()) {
                    return false; 
                }

                // If we got here, the form is valid — continue
                $('#submit-button')
                    .attr('disabled', true)
                    .attr('aria-busy', 'true');
                $('#form-loading')
                    .removeClass('sr-only')
                    .attr('aria-hidden', 'false');

                return true;
            });

            // Initialise
            updateMembershipDescription();
            enableAutocomplete();
            $('#genderNote').toggle($('#Gender').val() === 'Other');
            $('#cdh-section').toggle($('#HasCdhId').is(':checked'));
        });

        // Determine client fingerprint.
        const fpPromise = FingerprintJS.load();

        fpPromise.then(fp => fp.get()).then(result => {
            const fingerprint = result.visitorId;
            console.log('Fingerprint:', fingerprint);

            // Set the value of the existing hidden field
            const fingerprintInput = document.getElementById('Fingerprint');
            if (fingerprintInput) {
                fingerprintInput.value = fingerprint;
            } else {
                console.warn('Fingerprint hidden field not found.');
            }
        });

        // Frame height
        let lastHeight = 0;

        function sendHeight() {
          const newHeight = document.body.scrollHeight;
          if (newHeight !== lastHeight) {
            window.parent.postMessage({ frameHeight: newHeight }, '*');
            lastHeight = newHeight;
          }
        }

        window.addEventListener('load', sendHeight);

        // Use MutationObserver for better dynamic watching
        const observer = new MutationObserver(sendHeight);
        observer.observe(document.body, { attributes: true, childList: true, subtree: true });
    </script>
}

