@model BOTGC.MembershipApplication.Models.MembershipApplication

@{
    ViewData["Title"] = "Membership Application";
}

<h1 id="membership-form-heading">Membership Application</h1>

<div id="error-summary" tabindex="-1" class="sr-only" aria-hidden="true">There are validation errors on the form</div>

<form asp-action="Apply" method="post" novalidate aria-labelledby="membership-form-heading">
    @Html.AntiForgeryToken()

    <div asp-validation-summary="All" role="alert" aria-live="assertive"></div>

    <fieldset>
        <legend class="sr-only">Membership Application Details</legend>

        <div class="form-group">
            <label asp-for="MembershipCategory">Membership Category<span aria-hidden="true">*</span></label>
            <select asp-for="MembershipCategory" required aria-required="true">
                <option disabled selected value="">Please select</option>
                <option>Full playing</option>
                <option>Youth</option>
                <option>Junior</option>
                <option>2nd Club</option>
                <option>Overseas</option>
                <option>New2Golf</option>
                <option>House</option>
            </select>
            <span asp-validation-for="MembershipCategory"></span>
        </div>

        <div class="form-group">
            <label asp-for="Gender">Gender<span aria-hidden="true">*</span></label>
            <select asp-for="Gender" required aria-required="true">
                <option disabled selected value="">Please select</option>
                <option value="1">Male</option>
                <option value="2">Female</option>
                <option value="3">Other</option>
            </select>
            <span asp-validation-for="Gender"></span>
        </div>

        <div class="form-group">
            <label asp-for="Title">Title<span aria-hidden="true">*</span></label>
            <select asp-for="Title" required aria-required="true">
                <option disabled selected value="">Please select</option>
                <option>Mr.</option>
                <option>Mrs.</option>
                <option>Ms.</option>
                <option>Miss</option>
                <option>Dr.</option>
            </select>
            <span asp-validation-for="Title"></span>
        </div>

        <div class="form-group">
            <label asp-for="Forename">Forename<span aria-hidden="true">*</span></label>
            <input asp-for="Forename" required aria-required="true" autocomplete="given-name" />
            <span asp-validation-for="Forename"></span>
        </div>

        <div class="form-group">
            <label asp-for="Surname">Surname<span aria-hidden="true">*</span></label>
            <input asp-for="Surname" required aria-required="true" autocomplete="family-name" />
            <span asp-validation-for="Surname"></span>
        </div>

        <div class="form-group">
            <label asp-for="DateOfBirth">Date of Birth<span aria-hidden="true">*</span></label>
            <input asp-for="DateOfBirth" type="date" required aria-required="true" autocomplete="bday" />
            <span asp-validation-for="DateOfBirth"></span>
        </div>

        <div class="form-group">
            <label asp-for="Telephone">Telephone<span aria-hidden="true">*</span></label>
            <input asp-for="Telephone" required aria-required="true" autocomplete="tel" />
            <span asp-validation-for="Telephone"></span>
        </div>

        <div class="form-group">
            <label asp-for="AlternativeTelephone">Alternative Telephone</label>
            <input asp-for="AlternativeTelephone" autocomplete="tel" />
            <span asp-validation-for="AlternativeTelephone"></span>
        </div>

        <div class="form-group">
            <label asp-for="Email">Email Address<span aria-hidden="true">*</span></label>
            <input asp-for="Email" type="email" required aria-required="true" autocomplete="email" aria-describedby="emailHelp" />
            <small id="emailHelp" class="form-text text-muted">We’ll never share your email address.</small>
            <span asp-validation-for="Email"></span>
        </div>

        <div class="form-group">
            <label asp-for="AddressLine1">First Address Line<span aria-hidden="true">*</span></label>
            <input asp-for="AddressLine1" id="AddressLine1" required aria-required="true" autocomplete="address-line1" />
            <small id="address-help" class="form-text text-muted">
                Start typing your address and select it from the list, or complete the fields manually.
            </small>
            <span asp-validation-for="AddressLine1"></span>
        </div>

        <div class="form-group">
            <label asp-for="AddressLine2">Second Address Line</label>
            <input asp-for="AddressLine2" id="AddressLine2" autocomplete="address-line2" />
            <span asp-validation-for="AddressLine2"></span>
        </div>

        <div class="form-group">
            <label asp-for="Town">Town / City<span aria-hidden="true">*</span></label>
            <input asp-for="Town" id="Town" required aria-required="true" autocomplete="address-level2" />
            <span asp-validation-for="Town"></span>
        </div>

        <div class="form-group">
            <label asp-for="County">County</label>
            <input asp-for="County" id="County" autocomplete="address-level1" />
            <span asp-validation-for="County"></span>
        </div>

        <div class="form-group">
            <label asp-for="Postcode">Postcode<span aria-hidden="true">*</span></label>
            <input asp-for="Postcode" id="Postcode" required aria-required="true" autocomplete="postal-code" />
            <span asp-validation-for="Postcode"></span>
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" asp-for="HasCdhId" type="checkbox" />
            <label class="form-check-label" asp-for="HasCdhId">I have a CDH ID</label>
        </div>

        <div class="form-group">
            <label asp-for="CdhId">CDH ID (if applicable)</label>
            <input asp-for="CdhId" autocomplete="off" />
            <span asp-validation-for="CdhId"></span>
        </div>

        <div class="form-group">
            <label asp-for="PaymentType">Payment Type<span aria-hidden="true">*</span></label>
            <select asp-for="PaymentType" required aria-required="true">
                <option disabled selected value="">Please select</option>
                <option>Annual</option>
                <option>Monthly</option>
            </select>
            <span asp-validation-for="PaymentType"></span>
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" asp-for="AgreeToClubRules" type="checkbox" required aria-required="true" aria-describedby="rulesHelp" />
            <label class="form-check-label" asp-for="AgreeToClubRules">
                I agree to the club rules<span aria-hidden="true">*</span>
            </label>
            <small id="rulesHelp" class="form-text text-muted">You must agree before submitting.</small>
            <span asp-validation-for="AgreeToClubRules"></span>
        </div>

        <p class="text-muted mt-4">
            By submitting this application, you consent to the processing of your personal data in accordance with our
            <a href="/privacy" target="_blank" rel="noopener">Privacy Policy</a>.
        </p>

        <button id="submit-button" type="submit" aria-busy="false">Submit Application</button>
        <span id="form-loading" class="sr-only" aria-hidden="true">Submitting...</span>
    </fieldset>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="https://cdn.getaddress.io/scripts/getaddress-autocomplete-3.0.9.js"></script>

    <script defer>
        const enableAutocomplete = async () => {
            await getAddress.autocomplete('AddressLine1', '@ViewData["GetAddressApiKey"]', {
                selected: (address) => {
                    const line1 = address.formatted_address[0] || ''
                    const line2 = address.formatted_address[1] || ''
                    const townRaw = address.formatted_address[3] || ''
                    const county = address.formatted_address[4] || ''
                    const postcode = address.postcode || ''

                    // Clean and assign line1
                    document.getElementById('AddressLine1').value = line1

                    // Conditional adjustment for line2 and town
                    if (townRaw.includes(',') && !line2) {
                        const [before, after] = townRaw.split(',').map(s => s.trim())
                        document.getElementById('AddressLine2').value = before
                        document.getElementById('Town').value = after
                    } else {
                        document.getElementById('AddressLine2').value = line2
                        document.getElementById('Town').value = townRaw
                    }

                    document.getElementById('County').value = county
                    document.getElementById('Postcode').value = postcode
                }
            })
        }

        enableAutocomplete()
    </script>

    <script>
        $(function () {
            const errorSummary = $('[data-valmsg-summary="true"]');
            if (errorSummary.length && errorSummary.text().trim().length) {
                $('#error-summary').removeAttr('aria-hidden').focus();
            }

            $('form').on('submit', function () {
                $('#submit-button')
                    .attr('disabled', true)
                    .attr('aria-busy', 'true');
                $('#form-loading')
                    .removeClass('sr-only')
                    .attr('aria-hidden', 'false');
            });
        });
    </script>
}
