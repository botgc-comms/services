(()=>{"use strict";var t;t=()=>{const t="wastage_operator_id",e="wastage_operator_ts",n="wastage_last_activity";let o=(new Date).toDateString(),a=null,r=null,l=null,s=null,c=!1,i=null,d=null,u="",m=null,p=!1,g=!1;document.addEventListener("click",t=>{const e=t.target.closest(".delete-btn");e&&(i=e.dataset.id,i&&document.getElementById("confirmDeleteDialog").showModal())}),document.querySelectorAll(".qty-quick button").forEach(t=>{t.addEventListener("click",()=>{const e=parseFloat(t.dataset.add||"0"),n=document.getElementById("qty"),o=parseFloat(n.value||"0"),a=(isNaN(o)?0:o)+e;n.value=(Math.round(100*a)/100).toString(),n.dispatchEvent(new Event("input",{bubbles:!0}))})}),document.getElementById("confirmDeleteYes").addEventListener("click",async()=>{i&&((await fetch(`/wastage/entry/${i}`,{method:"DELETE"})).ok?document.querySelector(`#sheetBody tr[data-id='${i}']`)?.remove():alert("Failed to delete entry."),document.getElementById("confirmDeleteDialog").close(),i=null)}),document.getElementById("confirmDeleteNo").addEventListener("click",()=>{i=null,document.getElementById("confirmDeleteDialog").close()});const y=document.getElementById("stocktakeAlertBtn");function f(t){const e=("; "+document.cookie).split("; "+t+"=");return 2===e.length?e.pop().split(";").shift():null}function h(t){document.cookie=`${t}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`}function E(){return Date.now()}function v(){const t=String(E());!function(t,e,n){let o="";if("number"==typeof n){const t=new Date;t.setTime(t.getTime()+24*n*60*60*1e3),o="; expires="+t.toUTCString()}document.cookie=`${t}=${e}; path=/; SameSite=Lax${o}`}(e,t,365);try{localStorage.setItem(n,t)}catch{}x()}function I(){const t=parseInt(f(e)||"0",10);return!t||E()-t>18e4}function w(){h(t),h(e),N(),u="";const n=document.getElementById("operatorStatus");n&&(n.innerHTML='<span class="muted">No operator selected.</span>')}function S(){f(t)&&I()&&(w(),D(),document.getElementById("reasonModal")?.open&&document.getElementById("reasonModal").close(),document.getElementById("searchModal")?.open&&document.getElementById("searchModal").close(),k())}function B(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function L(t,e,n,o,a,r){const l=document.createElement("tr");l.dataset.id=a;const s=r?new Date(r):new Date,c=s.getHours().toString().padStart(2,"0"),i=s.getMinutes().toString().padStart(2,"0");var d;l.innerHTML=`<td>${c}:${i}</td>\n                 <td>${B(t)}</td>\n                 <td class="cell--product" title="${B(e)}">${B(e)}</td>\n                 <td class="cell--reason"  title="${B(n)}">${B((d=n,String(d??"").replace(/\//g,"/​")))}</td>\n                 <td>${B(o)}</td>\n                 <td>\n                    <button class="btn btn-link text-danger p-0 delete-btn" data-id="${a}" title="Delete">\n                      <i class="bi bi-trash"></i>\n                    </button>\n                 </td>`,document.getElementById("sheetBody").prepend(l)}async function b(){try{const t=await async function(){const t=await fetch("/wastage/sheet");return t.ok?await t.json():null}();if(!t)return;const e={};document.querySelectorAll("#operatorTiles .tile").forEach(t=>e[t.dataset.opid]=t.textContent),t.entries.sort((t,e)=>new Date(e.at)-new Date(t.at));const n=new Set(t.entries.map(t=>t.id)),o=document.getElementById("sheetBody");Array.from(o.querySelectorAll("tr")).forEach(t=>{n.has(t.dataset.id)||t.remove()});const a=new Set(Array.from(document.querySelectorAll("#sheetBody tr")).map(t=>t.dataset.id));t.entries.forEach(t=>{a.has(t.id)||L(e[t.operatorId]||"Unknown",t.productName,t.reason,t.quantity,t.id,t.at)})}catch{}}function k(){!function(){const t=JSON.parse(localStorage.getItem("op_popularity")||"{}"),e=Array.from(document.querySelectorAll("#operatorTiles .tile"));e.sort((e,n)=>(t[n.dataset.opid]||0)-(t[e.dataset.opid]||0));const n=document.getElementById("operatorTiles");n.innerHTML="",e.forEach(t=>n.appendChild(t))}();const t=document.getElementById("operatorModal");t.addEventListener("cancel",t=>t.preventDefault()),t.showModal()}function $(t,e){const n=document.getElementById("operatorStatus"),o=function(t){if(!t)return"#111";var e=t.replace(/^#/,"");return 3===e.length&&(e=e.split("").map(t=>t+t).join("")),6!==e.length||(299*parseInt(e.substr(0,2),16)+587*parseInt(e.substr(2,2),16)+114*parseInt(e.substr(4,2),16))/1e3>=150?"#111":"#fff"}(e),a=function(t,e=.12){let n=(t||"#999").replace(/^#/,"");3===n.length&&(n=n.split("").map(t=>t+t).join(""));const o=parseInt(n.slice(0,2),16),a=parseInt(n.slice(2,4),16),r=parseInt(n.slice(4,6),16),l=Math.round((1-e)*o).toString(16).padStart(2,"0"),s=Math.round((1-e)*a).toString(16).padStart(2,"0"),c=Math.round((1-e)*r).toString(16).padStart(2,"0");return`#${l}${s}${c}`}(e,.12);n.innerHTML=`<div class="tile tile--op" style="background:${e}; color:${o}; --badge:${a};">\n                    <span class="pill-dot" style="background:${o};"></span>\n                    <span class="tile__name">${t}</span>\n                    <small class="tile__division"><span id="opTtl"></span></small>\n                </div>`,function(){const t=document.querySelector("#operatorStatus .tile--op");t&&(t.style.cursor="pointer",t.addEventListener("click",k))}(),N(),x(),_=setInterval(x,1e3),R()}function M(){f(t)?I()&&(w(),k()):k()}function D(){const e=f(t),n=document.getElementById("operatorStatus");if(!e)return void(n.innerHTML='<span class="muted">No operator selected.</span>');const o=document.querySelector(`#operatorTiles .tile[data-opid='${e}']`);if(!o)return w(),void M();$(o.textContent.trim(),o.dataset.color||"#555555")}function T(e,n,o,l){if(f(t)){if(I())return w(),void M();a={id:e,name:n,igid:o,unit:l,components:[]},fetch(`/wastage/product/${e}`).then(t=>t.ok?t.json():null).then(t=>{t&&(a.name=t.name,a.igid=t.igProductId,a.unit=t.unit,a.components=Array.isArray(t.components)?t.components:[]),document.getElementById("reasonTitle").textContent=`Reason for: ${a.name}`;const e=document.getElementById("customReason");e.value="",e.dataset.autofill="0",document.getElementById("qty").value="";const n=(a.unit||"").trim();document.getElementById("qtyUnit").textContent=n?`(${n})`:"";const o=document.getElementById("qty");/pint|half|ml|ltr|liter|litre/i.test(n)?o.step="0.25":o.step="1",function(t){const e=function(t){if(!t)return"";const e=t.trim().toLowerCase();return e.includes("can")?"can":e.includes("bottle")?"bottle":e.includes("pint")?"pint":e.includes("half")?"half":e.includes("ml")||e.includes("shot")||e.includes("measure")?"ml":e}(t),n=document.querySelectorAll(".reason-btn");let o=!1;n.forEach(t=>{let n=(t.dataset.excludedunits||"").toLowerCase();if(!n){const e=t.firstChild.textContent.trim().toLowerCase();n=(A[e]||[]).join("|")}const a=n.split("|").map(t=>t.trim()).filter(Boolean),r=e&&a.includes(e);t.style.display=r?"none":"",r&&t.classList.contains("is-selected")&&(t.classList.remove("is-selected"),o=!0)}),o&&(r=null)}(a.unit),document.getElementById("reasonModal").showModal()})}else M()}y&&y.addEventListener("click",()=>{if(p=!0,j(),!d||!d.url)return;const t=d.url,e=u||"",n=t.includes("?")?"&":"?",o=`${t}${n}operator=${encodeURIComponent(e)}`;window.open(o,"_blank","noopener")}),Array.from(document.querySelectorAll("#operatorTiles .tile")).forEach(t=>{t.addEventListener("click",async()=>{const e=t.dataset.opid,n=new FormData;n.append("id",e),(await fetch("/wastage/select-operator",{method:"POST",body:n})).ok&&(function(t){const e="op_popularity",n=JSON.parse(localStorage.getItem(e)||"{}");n[t]=(n[t]||0)+1,localStorage.setItem(e,JSON.stringify(n))}(e),v(),document.getElementById("operatorModal").close(),D())})}),Array.from(document.querySelectorAll("#topTiles .tile")).forEach(t=>{"openSearch"!==t.id&&t.addEventListener("click",()=>T(t.dataset.id,t.dataset.name,t.dataset.igid,t.dataset.unit))}),document.getElementById("openSearch").addEventListener("click",()=>{if(f(t)){if(I())return w(),void M();document.getElementById("searchResults").innerHTML="",document.getElementById("searchInput").value="",document.getElementById("searchModal").showModal(),document.getElementById("searchInput").focus()}else M()}),document.getElementById("searchInput").addEventListener("input",async t=>{const e=t.target.value.trim(),n=document.getElementById("searchResults");if(n.innerHTML="",e.length<2)return;const o=await fetch(`/wastage/search?q=${encodeURIComponent(e)}`);if(!o.ok)return;const a=await o.json();a.forEach(t=>{const e=(t.category||"uncategorised").toLowerCase().normalize("NFKD").replace(/&/g," ").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),o=document.createElement("div");o.className=`tile cat-${e}`,o.dataset.id=t.id,o.dataset.name=t.name,o.dataset.igid=t.igProductId,o.dataset.unit=t.unit,o.innerHTML=`\n                    <div class="tile__name">${t.name}</div>\n                    <small class="tile__division">${t.category||""}</small>\n                `,o.addEventListener("click",()=>{document.getElementById("searchModal").close(),T(t.id,t.name,t.igProductId,t.unit)}),n.appendChild(o)})});const q=document.getElementById("customReason");Array.from(document.querySelectorAll(".reason-btn")).forEach(t=>{t.addEventListener("click",()=>{if("none"===t.style.display||t.disabled)return;r=t.dataset.reasonid,document.querySelectorAll(".reason-btn.is-selected").forEach(t=>t.classList.remove("is-selected")),t.classList.add("is-selected");const e=t.dataset.defaultqty;e&&(document.getElementById("qty").value=e);const n=(t.firstChild?.textContent||t.textContent||"").trim();q.value=n,q.dataset.autofill="1"})}),q.addEventListener("input",()=>{q.dataset.autofill="0"});const A={"drip tray":["can","bottle","ml"],"barrel change":["can","bottle","ml"],"pipe clean":["can","bottle","ml"],"bar pull through":["can","bottle","ml"]};document.getElementById("logBtn").addEventListener("click",async()=>{if(c)return;if(!a)return;if(I())return w(),void M();const t=parseFloat(document.getElementById("qty").value||"0");if(!(t>0))return void alert("Enter a quantity greater than zero.");const e=document.getElementById("customReason"),n=e.value.trim(),o="1"===e.dataset.autofill;let l=null;(r&&o||!n&&r)&&(l=r);const s=document.getElementById("logBtn");c=!0,s.disabled=!0;const i=s.textContent;s.textContent="Logging…";try{const o=new FormData;o.append("productId",a.id),o.append("quantity",t.toString());const s=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16));o.append("clientId",s),l?o.append("reasonId",l):n&&o.append("customReason",n);let c="/wastage/log";const i=Array.isArray(a.components)&&a.components.length>0;i&&a.components.length>1?c="/wastage/log-product":(o.append("igProductId",(a.igid||0).toString()),o.append("unit",a.unit||""),o.append("productName",a.name||"")),await fetch(c,{method:"POST",body:o}),v(),document.getElementById("reasonModal").close(),a=null,r=null,document.getElementById("qty").value="",e.value="",e.dataset.autofill="0",document.querySelectorAll(".reason-btn.is-selected").forEach(t=>t.classList.remove("is-selected")),await b()}catch{alert("Failed to log waste.")}finally{c=!1,s.disabled=!1,s.textContent=i}});let C=null,_=null;function x(){const n=document.getElementById("opTtl");if(!n)return;if(!f(t))return n.textContent="",void N();const o=parseInt(f(e)||"0",10)+18e4-E();if(o<=0)return n.textContent="0:00",void S();n.textContent=function(t){const e=Math.max(0,Math.floor(t/1e3));return`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`}(o)}function N(){_&&(clearInterval(_),_=null)}function R(){const t=document.getElementById("stocktakeAlert");if(!t)return;const e=d&&d.due&&d.url;e&&t.hidden?(t.hidden=!1,function(){if(j(),!d||!d.chimeEnabled)return;let t=parseInt(d.chimeIntervalMinutes,10);(!t||t<=0)&&(t=15),m=setInterval(()=>{F()&&H()},60*t*1e3)}(),F()&&H()):e||(t.hidden=!0,j())}function H(){if(!g)return;const t=document.getElementById("stocktakeSound"),e=document.getElementById("stocktakeAlertBtn");if(e&&(e.classList.remove("stocktake-alert__btn--shiver"),e.offsetWidth,e.classList.add("stocktake-alert__btn--shiver"),setTimeout(()=>e.classList.remove("stocktake-alert__btn--shiver"),500)),t)try{t.currentTime=0,t.play()}catch{}}function F(){return!(!g||!(d&&d.due&&d.url)||!d.chimeEnabled||p||!function(){if(!d)return!1;const t=d.chimeStart,e=d.chimeEnd,n=U(t),o=U(e);if(null===n||null===o)return!0;const a=new Date,r=60*a.getHours()+a.getMinutes();return n<=o?r>=n&&r<=o:r>=n||r<=o}())}function j(){m&&(clearInterval(m),m=null)}function U(t){if(!t||"string"!=typeof t)return null;const e=t.split(":");if(2!==e.length)return null;const n=parseInt(e[0],10),o=parseInt(e[1],10);return isNaN(n)||isNaN(o)||n<0||n>23||o<0||o>59?null:60*n+o}D(),M(),l&&clearInterval(l),l=setInterval(b,7e3),C=(new signalR.HubConnectionBuilder).withUrl("/hubs/wastage").withAutomaticReconnect().build(),C.on("EntryAdded",async()=>{await b()}),C.on("EntriesAdded",async()=>{await b()}),C.on("EntryDeleted",async()=>{await b()}),C.on("SheetSubmitted",t=>{}),C.start().catch(t=>console.error(t)),function(){s&&clearInterval(s);let t=E();s=setInterval(()=>{const e=E();e-t>3e4&&S(),S(),t=e},15e3),window.addEventListener("focus",S),window.addEventListener("pageshow",S),document.addEventListener("visibilitychange",()=>{document.hidden||S()}),window.addEventListener("storage",t=>{t.key===n&&S()})}(),function(){function t(){(new Date).toDateString()!==o&&location.reload()}setInterval(t,15e3),document.addEventListener("visibilitychange",()=>{document.hidden||t()});const e=new Date,n=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,1,0);setTimeout(t,n.getTime()-e.getTime())}(),function(){let e=0;const n=()=>{if(g=!0,!f(t))return;const n=E();n-e>=5e3&&(v(),e=n)};document.addEventListener("click",n,{passive:!0,capture:!0}),document.addEventListener("keydown",n,{passive:!0,capture:!0}),document.addEventListener("pointerdown",n,{passive:!0,capture:!0}),document.addEventListener("touchstart",n,{passive:!0,capture:!0})}(),async function(){try{const t=await fetch("/wastage/stocktake-status");if(!t.ok)return;d=await t.json(),R()}catch{}}(),f(t)&&v()},"loading"!==document.readyState?t():document.addEventListener("DOMContentLoaded",t)})();