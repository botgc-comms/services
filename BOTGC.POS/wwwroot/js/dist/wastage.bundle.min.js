(()=>{"use strict";var t;t=()=>{const t="wastage_operator_id",e="wastage_operator_ts",n="wastage_last_activity";let o=(new Date).toDateString(),a=null,r=null,l=null,s=null,d=!1,c=null;function i(t){const e=("; "+document.cookie).split("; "+t+"=");return 2===e.length?e.pop().split(";").shift():null}function u(t){document.cookie=`${t}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`}function m(){return Date.now()}function p(){const t=String(m());!function(t,e,n){let o="";if("number"==typeof n){const t=new Date;t.setTime(t.getTime()+24*n*60*60*1e3),o="; expires="+t.toUTCString()}document.cookie=`${t}=${e}; path=/; SameSite=Lax${o}`}(e,t,365);try{localStorage.setItem(n,t)}catch{}D()}function g(){const t=parseInt(i(e)||"0",10);return!t||m()-t>18e4}function y(){u(t),u(e),k();const n=document.getElementById("operatorStatus");n&&(n.innerHTML='<span class="muted">No operator selected.</span>')}function f(){i(t)&&g()&&(y(),B(),document.getElementById("reasonModal")?.open&&document.getElementById("reasonModal").close(),document.getElementById("searchModal")?.open&&document.getElementById("searchModal").close(),I())}function h(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function E(t,e,n,o,a,r){const l=document.createElement("tr");l.dataset.id=a;const s=r?new Date(r):new Date,d=s.getHours().toString().padStart(2,"0"),c=s.getMinutes().toString().padStart(2,"0");var i;l.innerHTML=`<td>${d}:${c}</td>\n                 <td>${h(t)}</td>\n                 <td class="cell--product" title="${h(e)}">${h(e)}</td>\n                 <td class="cell--reason"  title="${h(n)}">${h((i=n,String(i??"").replace(/\//g,"/​")))}</td>\n                 <td>${h(o)}</td>\n                 <td>\n                    <button class="btn btn-link text-danger p-0 delete-btn" data-id="${a}" title="Delete">\n                      <i class="bi bi-trash"></i>\n                    </button>\n                 </td>`,document.getElementById("sheetBody").prepend(l)}async function v(){try{const t=await async function(){const t=await fetch("/wastage/sheet");return t.ok?await t.json():null}();if(!t)return;const e={};document.querySelectorAll("#operatorTiles .tile").forEach(t=>e[t.dataset.opid]=t.textContent),t.entries.sort((t,e)=>new Date(e.at)-new Date(t.at));const n=new Set(t.entries.map(t=>t.id)),o=document.getElementById("sheetBody");Array.from(o.querySelectorAll("tr")).forEach(t=>{n.has(t.dataset.id)||t.remove()});const a=new Set(Array.from(document.querySelectorAll("#sheetBody tr")).map(t=>t.dataset.id));t.entries.forEach(t=>{a.has(t.id)||E(e[t.operatorId]||"Unknown",t.productName,t.reason,t.quantity,t.id,t.at)})}catch{}}function I(){!function(){const t=JSON.parse(localStorage.getItem("op_popularity")||"{}"),e=Array.from(document.querySelectorAll("#operatorTiles .tile"));e.sort((e,n)=>(t[n.dataset.opid]||0)-(t[e.dataset.opid]||0));const n=document.getElementById("operatorTiles");n.innerHTML="",e.forEach(t=>n.appendChild(t))}();const t=document.getElementById("operatorModal");t.addEventListener("cancel",t=>t.preventDefault()),t.showModal()}function w(t,e){const n=document.getElementById("operatorStatus"),o=function(t){if(!t)return"#111";var e=t.replace(/^#/,"");return 3===e.length&&(e=e.split("").map(t=>t+t).join("")),6!==e.length||(299*parseInt(e.substr(0,2),16)+587*parseInt(e.substr(2,2),16)+114*parseInt(e.substr(4,2),16))/1e3>=150?"#111":"#fff"}(e),a=function(t,e=.12){let n=(t||"#999").replace(/^#/,"");3===n.length&&(n=n.split("").map(t=>t+t).join(""));const o=parseInt(n.slice(0,2),16),a=parseInt(n.slice(2,4),16),r=parseInt(n.slice(4,6),16),l=Math.round((1-e)*o).toString(16).padStart(2,"0"),s=Math.round((1-e)*a).toString(16).padStart(2,"0"),d=Math.round((1-e)*r).toString(16).padStart(2,"0");return`#${l}${s}${d}`}(e,.12);n.innerHTML=`<div class="tile tile--op" style="background:${e}; color:${o}; --badge:${a};">\n                    <span class="pill-dot" style="background:${o};"></span>\n                    <span class="tile__name">${t}</span>\n                    <small class="tile__division"><span id="opTtl"></span></small>\n                </div>`,function(){const t=document.querySelector("#operatorStatus .tile--op");t&&(t.style.cursor="pointer",t.addEventListener("click",I))}(),k(),D(),q=setInterval(D,1e3)}function S(){i(t)?g()&&(y(),I()):I()}function B(){const e=i(t),n=document.getElementById("operatorStatus");if(!e)return void(n.innerHTML='<span class="muted">No operator selected.</span>');const o=document.querySelector(`#operatorTiles .tile[data-opid='${e}']`);if(!o)return y(),void S();w(o.textContent.trim(),o.dataset.color||"#555555")}function L(e,n,o,l){if(i(t)){if(g())return y(),void S();a={id:e,name:n,igid:o,unit:l,components:[]},fetch(`/wastage/product/${e}`).then(t=>t.ok?t.json():null).then(t=>{t&&(a.name=t.name,a.igid=t.igProductId,a.unit=t.unit,a.components=Array.isArray(t.components)?t.components:[]),document.getElementById("reasonTitle").textContent=`Reason for: ${a.name}`;const e=document.getElementById("customReason");e.value="",e.dataset.autofill="0",document.getElementById("qty").value="";const n=(a.unit||"").trim();document.getElementById("qtyUnit").textContent=n?`(${n})`:"";const o=document.getElementById("qty");/pint|half|ml|ltr|liter|litre/i.test(n)?o.step="0.25":o.step="1",function(t){const e=function(t){if(!t)return"";const e=t.trim().toLowerCase();return e.includes("can")?"can":e.includes("bottle")?"bottle":e.includes("pint")?"pint":e.includes("half")?"half":e.includes("ml")||e.includes("shot")||e.includes("measure")?"ml":e}(t),n=document.querySelectorAll(".reason-btn");let o=!1;n.forEach(t=>{let n=(t.dataset.excludedunits||"").toLowerCase();if(!n){const e=t.firstChild.textContent.trim().toLowerCase();n=($[e]||[]).join("|")}const a=n.split("|").map(t=>t.trim()).filter(Boolean),r=e&&a.includes(e);t.style.display=r?"none":"",r&&t.classList.contains("is-selected")&&(t.classList.remove("is-selected"),o=!0)}),o&&(r=null)}(a.unit),document.getElementById("reasonModal").showModal()})}else S()}document.addEventListener("click",t=>{const e=t.target.closest(".delete-btn");e&&(c=e.dataset.id,c&&document.getElementById("confirmDeleteDialog").showModal())}),document.querySelectorAll(".qty-quick button").forEach(t=>{t.addEventListener("click",()=>{const e=parseFloat(t.dataset.add||"0"),n=document.getElementById("qty"),o=parseFloat(n.value||"0"),a=(isNaN(o)?0:o)+e;n.value=(Math.round(100*a)/100).toString(),n.dispatchEvent(new Event("input",{bubbles:!0}))})}),document.getElementById("confirmDeleteYes").addEventListener("click",async()=>{c&&((await fetch(`/wastage/entry/${c}`,{method:"DELETE"})).ok?document.querySelector(`#sheetBody tr[data-id='${c}']`)?.remove():alert("Failed to delete entry."),document.getElementById("confirmDeleteDialog").close(),c=null)}),document.getElementById("confirmDeleteNo").addEventListener("click",()=>{c=null,document.getElementById("confirmDeleteDialog").close()}),Array.from(document.querySelectorAll("#operatorTiles .tile")).forEach(t=>{t.addEventListener("click",async()=>{const e=t.dataset.opid,n=new FormData;n.append("id",e),(await fetch("/wastage/select-operator",{method:"POST",body:n})).ok&&(function(t){const e="op_popularity",n=JSON.parse(localStorage.getItem(e)||"{}");n[t]=(n[t]||0)+1,localStorage.setItem(e,JSON.stringify(n))}(e),p(),document.getElementById("operatorModal").close(),B())})}),Array.from(document.querySelectorAll("#topTiles .tile")).forEach(t=>{"openSearch"!==t.id&&t.addEventListener("click",()=>L(t.dataset.id,t.dataset.name,t.dataset.igid,t.dataset.unit))}),document.getElementById("openSearch").addEventListener("click",()=>{if(i(t)){if(g())return y(),void S();document.getElementById("searchResults").innerHTML="",document.getElementById("searchInput").value="",document.getElementById("searchModal").showModal(),document.getElementById("searchInput").focus()}else S()}),document.getElementById("searchInput").addEventListener("input",async t=>{const e=t.target.value.trim(),n=document.getElementById("searchResults");if(n.innerHTML="",e.length<2)return;const o=await fetch(`/wastage/search?q=${encodeURIComponent(e)}`);if(!o.ok)return;const a=await o.json();a.forEach(t=>{const e=(t.category||"uncategorised").toLowerCase().normalize("NFKD").replace(/&/g," ").replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""),o=document.createElement("div");o.className=`tile cat-${e}`,o.dataset.id=t.id,o.dataset.name=t.name,o.dataset.igid=t.igProductId,o.dataset.unit=t.unit,o.innerHTML=`\n                    <div class="tile__name">${t.name}</div>\n                    <small class="tile__division">${t.category||""}</small>\n                `,o.addEventListener("click",()=>{document.getElementById("searchModal").close(),L(t.id,t.name,t.igProductId,t.unit)}),n.appendChild(o)})});const b=document.getElementById("customReason");Array.from(document.querySelectorAll(".reason-btn")).forEach(t=>{t.addEventListener("click",()=>{if("none"===t.style.display||t.disabled)return;r=t.dataset.reasonid,document.querySelectorAll(".reason-btn.is-selected").forEach(t=>t.classList.remove("is-selected")),t.classList.add("is-selected");const e=t.dataset.defaultqty;e&&(document.getElementById("qty").value=e);const n=(t.firstChild?.textContent||t.textContent||"").trim();b.value=n,b.dataset.autofill="1"})}),b.addEventListener("input",()=>{b.dataset.autofill="0"});const $={"drip tray":["can","bottle","ml"],"barrel change":["can","bottle","ml"],"pipe clean":["can","bottle","ml"],"bar pull through":["can","bottle","ml"]};document.getElementById("logBtn").addEventListener("click",async()=>{if(d)return;if(!a)return;if(g())return y(),void S();const t=parseFloat(document.getElementById("qty").value||"0");if(!(t>0))return void alert("Enter a quantity greater than zero.");const e=document.getElementById("customReason"),n=e.value.trim(),o="1"===e.dataset.autofill;let l=null;(r&&o||!n&&r)&&(l=r);const s=document.getElementById("logBtn");d=!0,s.disabled=!0;const c=s.textContent;s.textContent="Logging…";try{const o=new FormData;o.append("productId",a.id),o.append("quantity",t.toString());const s=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16));o.append("clientId",s),l?o.append("reasonId",l):n&&o.append("customReason",n);const d=await fetch("/wastage/log-product",{method:"POST",body:o});if(401===d.status)return y(),void S();if(!d.ok)return void alert("Failed to log waste.");p(),document.getElementById("reasonModal").close(),a=null,r=null,document.getElementById("qty").value="",e.value="",e.dataset.autofill="0",document.querySelectorAll(".reason-btn.is-selected").forEach(t=>t.classList.remove("is-selected")),await v()}catch{alert("Failed to log waste.")}finally{d=!1,s.disabled=!1,s.textContent=c}});let M=null,q=null;function D(){const n=document.getElementById("opTtl");if(!n)return;if(!i(t))return n.textContent="",void k();const o=parseInt(i(e)||"0",10)+18e4-m();if(o<=0)return n.textContent="0:00",void f();n.textContent=function(t){const e=Math.max(0,Math.floor(t/1e3));return`${Math.floor(e/60)}:${(e%60).toString().padStart(2,"0")}`}(o)}function k(){q&&(clearInterval(q),q=null)}B(),S(),l&&clearInterval(l),l=setInterval(v,7e3),M=(new signalR.HubConnectionBuilder).withUrl("/hubs/wastage").withUrl("/hubs/wastage").withAutomaticReconnect().build(),M.on("EntryAdded",async()=>{await v()}),M.on("EntriesAdded",async()=>{await v()}),M.on("EntryDeleted",async()=>{await v()}),M.on("SheetSubmitted",t=>{}),M.start().catch(t=>console.error(t)),function(){s&&clearInterval(s);let t=m();s=setInterval(()=>{const e=m();e-t>3e4&&f(),f(),t=e},15e3),window.addEventListener("focus",f),window.addEventListener("pageshow",f),document.addEventListener("visibilitychange",()=>{document.hidden||f()}),window.addEventListener("storage",t=>{t.key===n&&f()})}(),function(){function t(){(new Date).toDateString()!==o&&location.reload()}setInterval(t,15e3),document.addEventListener("visibilitychange",()=>{document.hidden||t()});const e=new Date,n=new Date(e.getFullYear(),e.getMonth(),e.getDate()+1,0,0,1,0);setTimeout(t,n.getTime()-e.getTime())}(),function(){let e=0;const n=()=>{if(!i(t))return;const n=m();n-e>=5e3&&(p(),e=n)};document.addEventListener("click",n,{passive:!0,capture:!0}),document.addEventListener("keydown",n,{passive:!0,capture:!0}),document.addEventListener("pointerdown",n,{passive:!0,capture:!0}),document.addEventListener("touchstart",n,{passive:!0,capture:!0})}(),i(t)&&p()},"loading"!==document.readyState?t():document.addEventListener("DOMContentLoaded",t)})();