(()=>{"use strict";var e;e=()=>{const e="wastage_operator_id",t="wastage_operator_ts",n="wastage_last_activity";let o=(new Date).toDateString(),a=null,r=null,l=null,d=null,s=!1,c=null;function i(e){const t=("; "+document.cookie).split("; "+e+"=");return 2===t.length?t.pop().split(";").shift():null}function u(e){document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`}function m(){return Date.now()}function p(){const e=String(m());!function(e,t,n){let o="";if("number"==typeof n){const e=new Date;e.setTime(e.getTime()+24*n*60*60*1e3),o="; expires="+e.toUTCString()}document.cookie=`${e}=${t}; path=/; SameSite=Lax${o}`}(t,e,365);try{localStorage.setItem(n,e)}catch{}k()}function g(){const e=parseInt(i(t)||"0",10);return!e||m()-e>18e4}function y(){u(e),u(t),D();const n=document.getElementById("operatorStatus");n&&(n.innerHTML='<span class="muted">No operator selected.</span>')}function f(){i(e)&&g()&&(y(),B(),document.getElementById("reasonModal")?.open&&document.getElementById("reasonModal").close(),document.getElementById("searchModal")?.open&&document.getElementById("searchModal").close(),I())}function E(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function h(e,t,n,o,a,r){const l=document.createElement("tr");l.dataset.id=a;const d=r?new Date(r):new Date,s=d.getHours().toString().padStart(2,"0"),c=d.getMinutes().toString().padStart(2,"0");var i;l.innerHTML=`<td>${s}:${c}</td>\n                 <td>${E(e)}</td>\n                 <td class="cell--product" title="${E(t)}">${E(t)}</td>\n                 <td class="cell--reason"  title="${E(n)}">${E((i=n,String(i??"").replace(/\//g,"/​")))}</td>\n                 <td>${E(o)}</td>\n                 <td>\n                    <button class="btn btn-link text-danger p-0 delete-btn" data-id="${a}" title="Delete">\n                      <i class="bi bi-trash"></i>\n                    </button>\n                 </td>`,document.getElementById("sheetBody").prepend(l)}async function v(){try{const e=await async function(){const e=await fetch("/wastage/sheet");return e.ok?await e.json():null}();if(!e)return;const t={};document.querySelectorAll("#operatorTiles .tile").forEach(e=>t[e.dataset.opid]=e.textContent),e.entries.sort((e,t)=>new Date(t.at)-new Date(e.at));const n=new Set(e.entries.map(e=>e.id)),o=document.getElementById("sheetBody");Array.from(o.querySelectorAll("tr")).forEach(e=>{n.has(e.dataset.id)||e.remove()});const a=new Set(Array.from(document.querySelectorAll("#sheetBody tr")).map(e=>e.dataset.id));e.entries.forEach(e=>{a.has(e.id)||h(t[e.operatorId]||"Unknown",e.productName,e.reason,e.quantity,e.id,e.at)})}catch{}}function I(){!function(){const e=JSON.parse(localStorage.getItem("op_popularity")||"{}"),t=Array.from(document.querySelectorAll("#operatorTiles .tile"));t.sort((t,n)=>(e[n.dataset.opid]||0)-(e[t.dataset.opid]||0));const n=document.getElementById("operatorTiles");n.innerHTML="",t.forEach(e=>n.appendChild(e))}();const e=document.getElementById("operatorModal");e.addEventListener("cancel",e=>e.preventDefault()),e.showModal()}function S(e,t){const n=document.getElementById("operatorStatus"),o=function(e){if(!e)return"#111";var t=e.replace(/^#/,"");return 3===t.length&&(t=t.split("").map(e=>e+e).join("")),6!==t.length||(299*parseInt(t.substr(0,2),16)+587*parseInt(t.substr(2,2),16)+114*parseInt(t.substr(4,2),16))/1e3>=150?"#111":"#fff"}(t),a=function(e,t=.12){let n=(e||"#999").replace(/^#/,"");3===n.length&&(n=n.split("").map(e=>e+e).join(""));const o=parseInt(n.slice(0,2),16),a=parseInt(n.slice(2,4),16),r=parseInt(n.slice(4,6),16),l=Math.round((1-t)*o).toString(16).padStart(2,"0"),d=Math.round((1-t)*a).toString(16).padStart(2,"0"),s=Math.round((1-t)*r).toString(16).padStart(2,"0");return`#${l}${d}${s}`}(t,.12);n.innerHTML=`<div class="tile tile--op" style="background:${t}; color:${o}; --badge:${a};">\n                    <span class="pill-dot" style="background:${o};"></span>\n                    <span class="tile__name">${e}</span>\n                    <small class="tile__division"><span id="opTtl"></span></small>\n                </div>`,function(){const e=document.querySelector("#operatorStatus .tile--op");e&&(e.style.cursor="pointer",e.addEventListener("click",I))}(),D(),k(),q=setInterval(k,1e3)}function w(){i(e)?g()&&(y(),I()):I()}function B(){const t=i(e),n=document.getElementById("operatorStatus");if(!t)return void(n.innerHTML='<span class="muted">No operator selected.</span>');const o=document.querySelector(`#operatorTiles .tile[data-opid='${t}']`);if(!o)return y(),void w();S(o.textContent.trim(),o.dataset.color||"#555555")}function L(t,n,o,l){if(!i(e))return void w();if(g())return y(),void w();a={id:t,name:n,igid:o,unit:l},r=null,document.getElementById("reasonTitle").textContent=`Reason for: ${n}`;const d=document.getElementById("customReason");d.value="",d.dataset.autofill="0",document.getElementById("qty").value="";const s=(l||"").trim();document.getElementById("qtyUnit").textContent=s?`(${s})`:"";const c=document.getElementById("qty");/pint|half|ml|ltr|liter|litre/i.test(s)?c.step="0.25":c.step="1",function(e){const t=function(e){if(!e)return"";const t=e.trim().toLowerCase();return t.includes("can")?"can":t.includes("bottle")?"bottle":t.includes("pint")?"pint":t.includes("half")?"half":t.includes("ml")||t.includes("shot")||t.includes("measure")?"ml":t}(e),n=document.querySelectorAll(".reason-btn");let o=!1;n.forEach(e=>{let n=(e.dataset.excludedunits||"").toLowerCase();if(!n){const t=e.firstChild.textContent.trim().toLowerCase();n=(M[t]||[]).join("|")}const a=n.split("|").map(e=>e.trim()).filter(Boolean),r=t&&a.includes(t);e.style.display=r?"none":"",r&&e.classList.contains("is-selected")&&(e.classList.remove("is-selected"),o=!0)}),o&&(r=null)}(l),document.getElementById("reasonModal").showModal()}document.addEventListener("click",e=>{const t=e.target.closest(".delete-btn");t&&(c=t.dataset.id,c&&document.getElementById("confirmDeleteDialog").showModal())}),document.querySelectorAll(".qty-quick button").forEach(e=>{e.addEventListener("click",()=>{const t=parseFloat(e.dataset.add||"0"),n=document.getElementById("qty"),o=parseFloat(n.value||"0"),a=(isNaN(o)?0:o)+t;n.value=(Math.round(100*a)/100).toString(),n.dispatchEvent(new Event("input",{bubbles:!0}))})}),document.getElementById("confirmDeleteYes").addEventListener("click",async()=>{c&&((await fetch(`/wastage/entry/${c}`,{method:"DELETE"})).ok?document.querySelector(`#sheetBody tr[data-id='${c}']`)?.remove():alert("Failed to delete entry."),document.getElementById("confirmDeleteDialog").close(),c=null)}),document.getElementById("confirmDeleteNo").addEventListener("click",()=>{c=null,document.getElementById("confirmDeleteDialog").close()}),Array.from(document.querySelectorAll("#operatorTiles .tile")).forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.opid,n=new FormData;n.append("id",t),(await fetch("/wastage/select-operator",{method:"POST",body:n})).ok&&(function(e){const t="op_popularity",n=JSON.parse(localStorage.getItem(t)||"{}");n[e]=(n[e]||0)+1,localStorage.setItem(t,JSON.stringify(n))}(t),p(),document.getElementById("operatorModal").close(),B())})}),Array.from(document.querySelectorAll("#topTiles .tile")).forEach(e=>{"openSearch"!==e.id&&e.addEventListener("click",()=>L(e.dataset.id,e.dataset.name,e.dataset.igid,e.dataset.unit))}),document.getElementById("openSearch").addEventListener("click",()=>{if(i(e)){if(g())return y(),void w();document.getElementById("searchResults").innerHTML="",document.getElementById("searchInput").value="",document.getElementById("searchModal").showModal(),document.getElementById("searchInput").focus()}else w()}),document.getElementById("searchInput").addEventListener("input",async e=>{const t=e.target.value.trim(),n=document.getElementById("searchResults");if(n.innerHTML="",t.length<2)return;const o=await fetch(`/wastage/search?q=${encodeURIComponent(t)}`);if(!o.ok)return;const a=await o.json();a.forEach(e=>{const t=(e.category||"uncategorised").toLowerCase().replace(/\s+/g,"-").replace(/\//g,"-"),o=document.createElement("div");o.className=`tile cat-${t}`,o.dataset.id=e.id,o.dataset.name=e.name,o.dataset.igid=e.igProductId,o.dataset.unit=e.unit,o.innerHTML=`\n                    <div class="tile__name">${e.name}</div>\n                    <small class="tile__division">${e.category||""}</small>\n                `,o.addEventListener("click",()=>{document.getElementById("searchModal").close(),L(e.id,e.name,e.igProductId,e.unit)}),n.appendChild(o)})});const b=document.getElementById("customReason");Array.from(document.querySelectorAll(".reason-btn")).forEach(e=>{e.addEventListener("click",()=>{if("none"===e.style.display||e.disabled)return;r=e.dataset.reasonid,document.querySelectorAll(".reason-btn.is-selected").forEach(e=>e.classList.remove("is-selected")),e.classList.add("is-selected");const t=e.dataset.defaultqty;t&&(document.getElementById("qty").value=t);const n=(e.firstChild?.textContent||e.textContent||"").trim();b.value=n,b.dataset.autofill="1"})}),b.addEventListener("input",()=>{b.dataset.autofill="0"});const M={"drip tray":["can","bottle","ml"],"barrel change":["can","bottle","ml"],"pipe clean":["can","bottle","ml"],"bar pull through":["can","bottle","ml"]};document.getElementById("logBtn").addEventListener("click",async()=>{if(s)return;if(!a)return;if(g())return y(),void w();const e=parseFloat(document.getElementById("qty").value||"0");if(!(e>0))return void alert("Enter a quantity greater than zero.");const t=document.getElementById("customReason"),n=t.value.trim(),o="1"===t.dataset.autofill,l=new FormData;l.append("productId",a.id),l.append("igProductId",a.igid),l.append("unit",a.unit),l.append("productName",a.name),l.append("quantity",e.toString());const d=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16));if(l.append("clientId",d),r&&o)l.append("reasonId",r);else if(n)l.append("customReason",n),r=null;else{if(!r)return void alert("Please pick a reason or enter one.");l.append("reasonId",r)}const c=document.getElementById("logBtn");s=!0,c.disabled=!0;const i=c.textContent;c.textContent="Logging…";try{const e=await fetch("/wastage/log",{method:"POST",body:l});if(401===e.status)return y(),void w();if(!e.ok)return void alert("Failed to log waste.");p(),document.getElementById("reasonModal").close(),a=null,r=null,document.getElementById("qty").value="";const t=document.getElementById("customReason");t.value="",t.dataset.autofill="0",document.querySelectorAll(".reason-btn.is-selected").forEach(e=>e.classList.remove("is-selected")),await v()}finally{s=!1,c.disabled=!1,c.textContent=i}});let $=null,q=null;function k(){const n=document.getElementById("opTtl");if(!n)return;if(!i(e))return n.textContent="",void D();const o=parseInt(i(t)||"0",10)+18e4-m();if(o<=0)return n.textContent="0:00",void f();n.textContent=function(e){const t=Math.max(0,Math.floor(e/1e3));return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`}(o)}function D(){q&&(clearInterval(q),q=null)}B(),w(),l&&clearInterval(l),l=setInterval(v,7e3),$=(new signalR.HubConnectionBuilder).withUrl("/hubs/wastage").withAutomaticReconnect().build(),$.on("EntryAdded",async()=>{await v()}),$.on("EntryDeleted",async()=>{await v()}),$.on("SheetSubmitted",e=>{}),$.start().catch(e=>console.error(e)),function(){d&&clearInterval(d);let e=m();d=setInterval(()=>{const t=m();t-e>3e4&&f(),f(),e=t},15e3),window.addEventListener("focus",f),window.addEventListener("pageshow",f),document.addEventListener("visibilitychange",()=>{document.hidden||f()}),window.addEventListener("storage",e=>{e.key===n&&f()})}(),function(){function e(){(new Date).toDateString()!==o&&location.reload()}setInterval(e,15e3),document.addEventListener("visibilitychange",()=>{document.hidden||e()});const t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1,0,0,1,0);setTimeout(e,n.getTime()-t.getTime())}(),function(){let t=0;const n=()=>{if(!i(e))return;const n=m();n-t>=5e3&&(p(),t=n)};document.addEventListener("click",n,{passive:!0,capture:!0}),document.addEventListener("keydown",n,{passive:!0,capture:!0}),document.addEventListener("pointerdown",n,{passive:!0,capture:!0}),document.addEventListener("touchstart",n,{passive:!0,capture:!0})}(),i(e)&&p()},"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)})();