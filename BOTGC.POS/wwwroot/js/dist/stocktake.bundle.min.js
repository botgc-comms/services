(()=>{"use strict";const t="wastage_operator_id",e="wastage_operator_ts";let o=!1;const n={"WINES|BOTTLE":["CountInStoreRoom","CountInLoungeBar","OpenBottleWeightGrams@Lounge","CountInColtBar","OpenBottleWeightGrams@Colt"],"MINERALS|BOTTLE":["CountInStoreRoom","CountInLoungeBar","CountInColtBar"],"SNACKS|EACH":["CountInStoreRoom","CountInLoungeBar","CountInColtBar"],"BEER CANS|CAN":["CountInStoreRoom","CountInLoungeBar","CountInColtBar"],"DRAUGHT BEER|PINT":["CountInCellar","KegWeightGrams@Cellar"],"PANTRY|EACH":["CountInStoreRoom","CountInKitchen"],"PANTRY|BOTTLE":["CountInStoreRoom","CountInKitchen"],"PANTRY|*":["CountInStoreRoom","CountInKitchen"],"*|*":["CountInStoreRoom","CountInLoungeBar","CountInColtBar"]};function i(t,e){const o=`${(t||"").toUpperCase()}|${(e||"").toUpperCase()}`;return n[o]||n["*|*"]}function a(t){const[e,o]=String(t).split("@");return{code:e,location:o||null}}function s(t){const e=("; "+document.cookie).split("; "+t+"=");return 2===e.length?e.pop().split(";").shift():null}function c(t,e,o){let n="";if("number"==typeof o){const t=new Date;t.setTime(t.getTime()+24*o*60*60*1e3),n="; expires="+t.toUTCString()}document.cookie=`${t}=${e}; path=/; SameSite=Lax${n}`}function r(t){document.cookie=`${t}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`}function l(){return Date.now()}function d(){c(e,String(l()),365)}function u(){const t=parseInt(s(e)||"0",10);return!t||l()-t>9e5}function m(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function p(t){return String(t||"").toLowerCase().replace(/\s+/g,"-").replace(/\//g,"-")}function g(t){const e=new URL(window.location.href).searchParams.get(t);return null===e?null:e}function f(t){const e=function(t){let e=1779033703^t.length;for(let o=0;o<t.length;o++)e=Math.imul(e^t.charCodeAt(o),3432918353),e=e<<13|e>>>19;return function(){return e=Math.imul(e^e>>>16,2246822507),e=Math.imul(e^e>>>13,3266489909),e^=e>>>16,e>>>0}}(t);return o=e(),n=e(),i=e(),a=e(),function(){let t=(o>>>=0)+(n>>>=0)|0;return o=n^n>>>9,n=(i>>>=0)+(i<<3)|0,t=t+(a=(a>>>=0)+1|0)|0,i=(i=i<<21|i>>>11)+t|0,(t>>>0)/4294967296};var o,n,i,a}function b(t,e){const o=t.slice();for(let t=o.length-1;t>0;t--){const n=Math.floor(e()*(t+1));[o[t],o[n]]=[o[n],o[t]]}return o}let h=[],v=null;const C=new Map;let I=null;function y(){const o=s(t),n=document.getElementById("operatorStatus");if(!o)return n.innerHTML='<span class="muted">No operator selected.</span>',void S();const i=document.querySelector(`#operatorTiles .tile[data-opid='${o}']`);if(!i)return r(t),r(e),n.innerHTML='<span class="muted">No operator selected.</span>',void S();const a=i.dataset.color||"#cccccc";n.innerHTML=`<div class="tile tile--op" style="background:${a};"><span class="tile__name">${m(i.textContent.trim())}</span></div>`,n.querySelector(".tile--op").addEventListener("click",S)}function S(){const t=document.getElementById("operatorModal");t.addEventListener("cancel",t=>t.preventDefault(),{once:!0}),t.showModal()}async function $(t){const e=await fetch((o=t,`/stocktake/draft?division=${encodeURIComponent(o)}`));var o;if(!e.ok)return void C.clear();const n=await e.json();C.clear();for(const t of n)(t.observations?.length??0)>0&&C.set(t.stockItemId,t)}function k(t){if(!t?.length)return null;const e=t.map(t=>t.daysSinceLastStockTake).filter(t=>Number.isFinite(t));if(0===e.length)return null;const o=e.reduce((t,e)=>t+e,0);return Math.round(o/e.length)}function E(t){const e=String(t||"").trim().toLowerCase();return e?"bottle"===e?"bottles":"can"===e?"cans":"each"===e?"items":"pint"===e?"pints":e.endsWith("s")?e:e+"s":"items"}async function L(t){await $(t.division);let e=[];if(Array.from(C.keys()).length>0)for(const[,o]of C)e.push({stockItemId:o.stockItemId,name:o.name,unit:o.unit,division:t.division,currentQuantity:o.estimatedQuantityAtCapture??null});else e=t.products||[];v={...t,products:e},document.getElementById("divisionTitle").textContent=t.division,function(){const t=document.getElementById("productTiles");t.innerHTML="";const e=v?.division||"",o=v?.products||[];for(const n of o){const o=C.get(n.stockItemId),i=document.createElement("div");i.className="tile",i.dataset.stockItemId=n.stockItemId,i.dataset.name=n.name||"",i.dataset.unit=n.unit||"",i.dataset.division=e,i.dataset.estimate=n.currentQuantity??"",i.innerHTML=`<div class="tile__name">${m(n.name)}</div>\n                              <small class="tile__division">${m(n.unit||"")}</small>`,i.addEventListener("click",()=>N(n.stockItemId,n.name,e,n.unit)),t.appendChild(i),o&&T(n.stockItemId,o)}}(),function(){document.getElementById("obsTbody").innerHTML="";for(const[,t]of C)A(t.stockItemId)}(),document.getElementById("productsSection").hidden=!1,document.getElementById("observationsSection").hidden=0===C.size}function B(t){return Array.from(document.querySelectorAll(".tiles--products .tile")).find(e=>parseInt(e.dataset.stockItemId,10)===t)||null}function w(t){const e=i(t.division,t.unit).map(t=>a(t)),o=new Set((t.observations||[]).map(t=>`${t.code}@${t.location||""}`));let n=0;for(const t of e){const e=`${t.code}@${t.location||""}`;(t.code.startsWith("CountIn")?Array.from(o).some(e=>e.startsWith(`${t.code}@`)):o.has(e))||n++}return n}function T(t,e){const o=B(t);if(!o)return;o.classList.remove("tile--partial","tile--complete"),o.querySelector(".tile__badge")?.remove();if(!((e.observations||[]).length>0))return;const n=w(e);if(0===n)o.classList.add("tile--complete");else{o.classList.add("tile--partial");const t=document.createElement("span");t.className="tile__badge",t.textContent=`${n} left`,o.appendChild(t)}}function N(n,a,c,l){const d=document.getElementById("obsModal"),p=document.getElementById("obsTitle"),g=document.getElementById("obsFields");p.textContent=`Record observations: ${a}`;const f=function(t){return(v?.products||[]).find(e=>e.stockItemId===t)||null}(n),b=f?.currentQuantity??null,h=C.get(n)?.observations||[],I=i(c,l);!function(t,e,n,i,a){if(t.innerHTML="",o&&null!=a&&isFinite(a)){const e=document.createElement("div");e.className="obs-estimate",e.textContent=`Current estimated stock: ${a} ${E(i)}`,t.appendChild(e)}const s=document.createElement("div");s.className="obs-progress",t.appendChild(s);const c=document.createElement("div");c.className="obs-hint",c.textContent="Blank = not observed. 0 = none found.",t.appendChild(c);const r=document.createElement("div");r.className="obs-groups",t.appendChild(r);const l=new Map;(n||[]).forEach(t=>{const e=`${t.code}@${t.location||""}`;l.set(e,t.value)});const d=E(i);function u(t,e){const[o,n]=String(t).split("@"),i=n||null,a=`Number of unopened ${e}`;return"CountInStoreRoom"===o?{group:"Store Room",label:a,code:o,location:"Store"}:"CountInColtBar"===o?{group:"Colt bar",label:a,code:o,location:"Colt"}:"CountInLoungeBar"===o?{group:"Lounge bar",label:a,code:o,location:"Lounge"}:"CountInCellar"===o?{group:"Cellar",label:"Count",code:o,location:"Cellar"}:"OpenBottleWeightGrams"===o&&"Colt"===i?{group:"Colt bar",label:"Total weight of open bottles (g)",code:o,location:"Colt"}:"OpenBottleWeightGrams"===o&&"Lounge"===i?{group:"Lounge bar",label:"Total weight of open bottles (g)",code:o,location:"Lounge"}:"KegWeightGrams"===o&&"Cellar"===i?{group:"Cellar",label:"Weight of Keg being used (g)",code:o,location:"Cellar"}:"CountInKitchen"===o?{group:"Kitchen",label:a,code:o,location:"Kitchen"}:{group:"Other",label:o+(i?` (${i})`:""),code:o,location:i}}const p=["Store Room","Kitchen","Colt bar","Lounge bar","Cellar","Other"],g=new Map(p.map(t=>[t,[]]));for(const t of e){const e=u(t,d);g.get(e.group).push(e)}for(const t of p){const e=g.get(t)||[];if(!e.length)continue;const o=document.createElement("section");o.className="obs-group";const n=document.createElement("h4");n.className="obs-group__title",n.textContent=t,o.appendChild(n);const i=document.createElement("div");i.className="obs-row",o.appendChild(i);for(const t of e){const e=`${t.code}@${t.location||""}`,o=l.has(e)?l.get(e):"",n=document.createElement("div");n.className="obs-field",n.innerHTML=`<label class="obs-label">${m(t.label)}</label>\n                    <div class="obs-input-row">\n                        <input type="number" step="1" min="0"\n                            class="obs-input"\n                            data-code="${m(t.code)}"\n                            ${t.location?`data-location="${m(t.location)}"`:""}\n                            value="${""!==o?String(o):""}">\n                        <button type="button" class="btn-quick-zero" data-for="${m(e)}" aria-label="Set to none">None</button>\n                    </div>`,i.appendChild(n)}r.appendChild(o)}const f=document.createElement("div");f.className="obs-note",f.textContent="You can record some values now and come back later to complete this product. Observations should be completed before the end of the day.";const b=document.querySelector("#obsModal footer.actions");b.classList.add("obs-footer"),b.querySelector(".obs-note")?.remove();let h=b.querySelector(".obs-btns");if(!h){const t=document.getElementById("obsSaveBtn"),e=document.getElementById("obsCancelBtn");h=document.createElement("div"),h.className="obs-btns",b.appendChild(h),h.appendChild(t),h.appendChild(e)}function v(){const e=Array.from(t.querySelectorAll("input[data-code]")),o=e.length,n=e.filter(t=>""!==t.value).length,i=n===o;s.textContent=`${n} of ${o} observations recorded${i?" â€” Complete":""}`}b.prepend(f),t.addEventListener("input",t=>{t.target&&t.target.matches("input[data-code]")&&v()}),t.addEventListener("click",e=>{const o=e.target.closest(".btn-quick-zero");if(!o)return;const n=o.dataset.for,i=Array.from(t.querySelectorAll("input[data-code]")).find(t=>`${t.getAttribute("data-code")}@${t.getAttribute("data-location")||""}`===n);i&&(i.value="0",i.dispatchEvent(new Event("input",{bubbles:!0})),i.focus(),i.select())}),v()}(g,I,h,l,b);document.getElementById("obsSaveBtn").onclick=async()=>{const o=Array.from(g.querySelectorAll("input[data-code]")),i=[];for(const t of o){const e=t.value;if(""===e)continue;const o=parseFloat(e);!isFinite(o)||o<0||i.push({stockItemId:n,code:t.getAttribute("data-code"),location:t.getAttribute("data-location"),value:o})}const m=s(t);if(!m||u())return r(t),r(e),y(),d.close(),void S();const p=B(n),f=Number(p?.dataset?.estimate??""),b=Number.isFinite(f)?f:0,h={stockItemId:n,name:a,division:c,unit:l,operatorId:m,operatorName:document.querySelector("#operatorStatus .tile--op .tile__name")?.textContent?.trim()||"",at:(new Date).toISOString(),observations:i,estimatedQuantityAtCapture:b};(await fetch("/stocktake/observe",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(h)})).ok?(C.set(n,{...h}),A(n),T(n,h),document.getElementById("observationsSection").hidden=0===C.size,d.close()):alert("Failed to save observations.")},document.getElementById("obsCancelBtn").onclick=()=>d.close(),d.showModal()}function _(t){const e=i(t.division,t.unit),o=function(t){const e=t.observations||[];return new Set(e.map(t=>`${t.code}@${t.location||""}`))}(t),n=new Map((t.observations||[]).map(t=>[`${t.code}@${t.location||""}`,t.value])),s=[];function c(t,e){const{code:i,location:c}=a(t),r=`${i}@${c||""}`;o.has(r)?e(n.get(r)):s.push(`${function(t){const{code:e,location:o}=a(t);return"CountInLoungeBar"===e?"Count (Lounge bar)":"CountInColtBar"===e?"Count (Colt bar)":"CountInStoreRoom"===e?"Count (store room)":"CountInCellar"===e?"Count (cellar)":"OpenBottleWeightGrams"===e?o?`Total weight of open bottles (g, ${o})`:"Total weight of open bottles (g)":"KegWeightGrams"===e?"Weight of Keg in use (g)":"CountInKitchen"===e?"Count (kitchen)":e}(t)}: not observed`)}for(const t of e){const{code:e,location:o}=a(t);c(t,"CountInLoungeBar"===e?t=>s.push(`${t} in Lounge bar`):"CountInColtBar"===e?t=>s.push(`${t} in Colt bar`):"CountInStoreRoom"===e?t=>s.push(`${t} in store room`):"CountInCellar"===e?t=>s.push(`${t} in cellar`):"OpenBottleWeightGrams"===e?t=>s.push(`${t} g open bottle (${o})`):"KegWeightGrams"===e?t=>s.push(`${t} g keg weight`):"CountInKitchen"===e?t=>s.push(`${t} in kitchen`):t=>s.push(`${e}${o?` @ ${o}`:""}: ${t}`))}return s.join("; ")}function A(t){const e=document.getElementById("obsTbody"),o=C.get(t);if(!o)return;const n=o.at?function(t){const e=new Date(t);return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}(o.at):"",i=w(o),a=`${0===i?"Complete":`Incomplete: ${i} remaining`} â€” ${_(o)}`;let s=e.querySelector(`tr[data-id='${t}']`);s?(s.children[0].textContent=n,s.children[1].textContent=o.operatorName||"",s.querySelector(".cell--obs").textContent=a):(s=document.createElement("tr"),s.dataset.id=String(t),s.innerHTML=`<td>${m(n)}</td>\n                 <td>${m(o.operatorName||"")}</td>\n                 <td class="cell--product">${m(o.name)}</td>\n                 <td class="cell--obs">${m(a)}</td>\n                 <td>\n                    <button type="button" class="btn-icon js-edit" title="Edit"><i class="bi bi-pencil-square"></i></button>\n                    <button type="button" class="btn-icon text-danger js-remove" title="Remove"><i class="bi bi-trash"></i></button>\n                 </td>`,e.appendChild(s)),s.querySelector(".js-edit").onclick=()=>{N(o.stockItemId,o.name,o.division,o.unit)},s.querySelector(".js-remove").onclick=async()=>{const t=await fetch(((t,e)=>`/stocktake/observe/${t}?division=${encodeURIComponent(e)}`)(o.stockItemId,o.division),{method:"DELETE"});if(!t.ok)return void alert("Failed to remove.");C.delete(o.stockItemId),s.remove();const e=B(o.stockItemId);e&&(e.classList.remove("tile--partial","tile--complete"),e.querySelector(".tile__badge")?.remove()),document.getElementById("observationsSection").hidden=0===C.size}}var M;M=async()=>{Array.from(document.querySelectorAll("#operatorTiles .tile")).forEach(e=>{e.addEventListener("click",async()=>{const o=e.dataset.opid,n=new FormData;n.append("id",o),(await fetch("/stocktake/select-operator",{method:"POST",body:n})).ok&&(c(t,o,365),d(),document.getElementById("operatorModal").close(),y())})}),y(),function(){setInterval(()=>{if(s(t)&&u()){r(t),r(e),y();const o=document.getElementById("obsModal");o?.open&&o.close(),S()}},15e3);const o=()=>{s(t)&&d()};document.addEventListener("click",o,{capture:!0}),document.addEventListener("keydown",o,{capture:!0}),document.addEventListener("pointerdown",o,{capture:!0})}(),await async function(){if(window.signalR&&window.signalR.HubConnectionBuilder){I=(new signalR.HubConnectionBuilder).withUrl("/hubs/stocktake").withAutomaticReconnect().build(),I.on("OperatorSelected",e=>{const o=e.colorHex||"#cccccc",n=document.getElementById("operatorStatus");n.innerHTML=`<div class="tile tile--op" style="background:${o};"><span class="tile__name">${m(e.name)}</span></div>`,n.querySelector(".tile--op").addEventListener("click",S),c(t,e.id,365),d()}),I.on("ObservationUpserted",t=>{if(v&&t.division===v.division){if(0===(t.observations?.length??0)){C.delete(t.stockItemId),document.querySelector(`#obsTbody tr[data-id='${t.stockItemId}']`)?.remove();const e=B(t.stockItemId);e&&(e.classList.remove("tile--partial","tile--complete"),e.querySelector(".tile__badge")?.remove())}else C.set(t.stockItemId,t),A(t.stockItemId),T(t.stockItemId,t);document.getElementById("observationsSection").hidden=0===C.size}}),I.on("ObservationRemoved",({stockItemId:t,division:e})=>{if(!v||e!==v.division)return;C.delete(t);const o=document.querySelector(`#obsTbody tr[data-id='${t}']`);o&&o.remove();const n=B(t);n&&(n.classList.remove("tile--partial","tile--complete"),n.querySelector(".tile__badge")?.remove()),document.getElementById("observationsSection").hidden=0===C.size});try{await I.start()}catch{}}}(),await async function(){try{const t=await fetch("/stocktake/config",{headers:{accept:"application/json"}});if(t.ok){const e=await t.json();o=!!e.showEstimatedInDialog}}catch{}}(),h=await async function(){const t=await fetch("/stocktake/products",{headers:{accept:"application/json"}});return t.ok?await t.json():[]}();const n=null!==g("alldivisions"),i=parseInt(g("count")||"2",10),a=isFinite(i)&&i>0?i:2,l=n?h:function(t,e,o){const n=f(`stocktake:${(new Date).toISOString().slice(0,10)}`),i=t.filter(t=>Array.isArray(t.products)&&t.products.length>0),a=i.find(t=>(t.division||"").toLowerCase()===String(o||"").toLowerCase()),s=b(i.filter(t=>t!==a),n),c=[];a&&c.push(a);for(const t of s){if(c.length>=e)break;c.push(t)}return c}(h,a+1,"PANTRY"),$=document.getElementById("divisionTiles");if(!n){const t=document.createElement("div");t.className="muted",t.style.marginBottom=".5rem",t.textContent="Select a product division to get started.",$.parentElement.insertBefore(t,$)}!function(t){const e=document.getElementById("divisionTiles");e.innerHTML="";const o=[...t].map(t=>({...t,_avg:k(t.products)})).sort((t,e)=>e._avg-t._avg);for(const t of o){const o=document.createElement("div");o.className=`tile cat-${p(t.division)}`,o.dataset.division=t.division;const n=null==t._avg?"no history":`${t._avg} days`;o.innerHTML=`<div class="tile__name">${m(t.division)}</div><small class="tile__division">${n}</small>`,o.addEventListener("click",()=>L(t)),e.appendChild(o)}}(l),s(t)&&d()},"loading"!==document.readyState?M():document.addEventListener("DOMContentLoaded",M)})();