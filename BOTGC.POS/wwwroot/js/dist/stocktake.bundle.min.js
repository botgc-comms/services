(()=>{"use strict";const t="wastage_operator_id",e="wastage_operator_ts",n={"WINES|BOTTLE":["CountInStoreRoom","CountInFridge","OpenBottleWeightGrams"],"MINERALS|BOTTLE":["CountInStoreRoom","CountInFridge"],"SNACKS|EACH":["CountInStoreRoom"],"BEER CANS|CAN":["CountInStoreRoom","CountInFridge"]};function o(t){const e=(t||"").toLowerCase();return/(merlot|shiraz|syrah|malbec|rioja|tempranillo|cabernet|pinot noir|red)/.test(e)}function i(t,e){return"CountInStoreRoom"===t?"Count (store)":"CountInFridge"===t?o(e)?"Count (back bar)":"Count (fridge)":"OpenBottleWeightGrams"===t?"Open bottle weight (g)":t}function a(t,e){const o=`${(t||"").toUpperCase()}|${(e||"").toUpperCase()}`;return n[o]||["CountInStoreRoom"]}function c(t){const e=("; "+document.cookie).split("; "+t+"=");return 2===e.length?e.pop().split(";").shift():null}function s(t,e,n){let o="";if("number"==typeof n){const t=new Date;t.setTime(t.getTime()+24*n*60*60*1e3),o="; expires="+t.toUTCString()}document.cookie=`${t}=${e}; path=/; SameSite=Lax${o}`}function r(t){document.cookie=`${t}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`}function d(){return Date.now()}function l(){s(e,String(d()),365)}function u(){const t=parseInt(c(e)||"0",10);return!t||d()-t>9e5}function m(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function p(t){return String(t||"").toLowerCase().replace(/\s+/g,"-").replace(/\//g,"-")}let v=[],g=null;const I=new Map;let f=null;function y(){const n=c(t),o=document.getElementById("operatorStatus");if(!n)return o.innerHTML='<span class="muted">No operator selected.</span>',void b();const i=document.querySelector(`#operatorTiles .tile[data-opid='${n}']`);if(!i)return r(t),r(e),o.innerHTML='<span class="muted">No operator selected.</span>',void b();const a=i.dataset.color||"#cccccc";o.innerHTML=`<div class="tile tile--op" style="background:${a};"><span class="tile__name">${m(i.textContent.trim())}</span></div>`,o.querySelector(".tile--op").addEventListener("click",b)}function b(){const t=document.getElementById("operatorModal");t.addEventListener("cancel",t=>t.preventDefault(),{once:!0}),t.showModal()}async function S(t){const e=await fetch((n=t,`/stocktake/draft?division=${encodeURIComponent(n)}`));var n;if(!e.ok)return void I.clear();const o=await e.json();I.clear();for(const t of o)I.set(t.stockItemId,t)}function k(t){if(!t?.length)return 9999;let e=0;for(const n of t)e+=n.daysSinceLastStockTake??9999;return e/t.length}async function h(t){g=t,document.getElementById("divisionTitle").textContent=t.division,document.getElementById("divisionAge").textContent=`${Math.round(k(t.products))} days on average`,await S(t.division),function(){const t=document.getElementById("productTiles");t.innerHTML="";const e=g?.division||"",n=g?.products||[];for(const o of n){const n=I.get(o.stockItemId),i=document.createElement("div");i.className=`tile cat-${p(e)}`,i.dataset.stockItemId=o.stockItemId,i.dataset.name=o.name||"",i.dataset.unit=o.unit||"",i.dataset.division=e,i.innerHTML=`<div class="tile__name">${m(o.name)}</div><small class="tile__division">${m(o.unit||"")}</small>`,i.addEventListener("click",()=>$(o.stockItemId,o.name,e,o.unit)),t.appendChild(i),n&&C(o.stockItemId,n)}}(),function(){document.getElementById("obsTbody").innerHTML="";for(const[,t]of I)B(t.stockItemId)}(),document.getElementById("productsSection").hidden=!1,document.getElementById("observationsSection").hidden=0===I.size}function E(t){return Array.from(document.querySelectorAll(".tiles--products .tile")).find(e=>parseInt(e.dataset.stockItemId,10)===t)||null}function C(t,e){const n=E(t);if(!n)return;n.classList.remove("tile--partial","tile--complete");const o=a(e.division,e.unit),i=new Set((e.observations||[]).map(t=>t.code));if(0===(e.observations||[]).length)return;const c=o.every(t=>i.has(t));n.classList.add(c?"tile--complete":"tile--partial")}function $(n,s,d,l){const p=document.getElementById("obsModal"),v=document.getElementById("obsTitle"),g=document.getElementById("obsFields");v.textContent=`Record observations: ${s}`;const f=I.get(n)?.observations||[],S=a(d,l);!function(t,e,n,a){t.innerHTML="";for(const c of e){const e=document.createElement("div");e.className="obs-field";const s=n?.find(t=>t.code===c)?.value??"",r=i(c,a),d="CountInFridge"===c?o(a)?"BackBar":"Fridge":"CountInStoreRoom"===c?"Store":"Bar";e.innerHTML=`<label>${m(r)}</label><input type="number" step="1" min="0" data-code="${c}" data-location="${d}" value="${s}">`,t.appendChild(e)}}(g,S,f,s);document.getElementById("obsSaveBtn").onclick=async()=>{const o=Array.from(g.querySelectorAll("input[data-code]")),i=[];for(const t of o){const e=parseFloat(t.value||"0");e>0&&i.push({stockItemId:n,code:t.getAttribute("data-code"),location:t.getAttribute("data-location"),value:e})}const a=c(t);if(!a||u())return r(t),r(e),y(),p.close(),void b();const m={stockItemId:n,name:s,division:d,unit:l,operatorId:a,operatorName:document.querySelector("#operatorStatus .tile--op .tile__name")?.textContent?.trim()||"",at:(new Date).toISOString(),observations:i};(await fetch("/stocktake/observe",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(m)})).ok?(I.set(n,{...m}),B(n),C(n,m),document.getElementById("observationsSection").hidden=0===I.size,p.close()):alert("Failed to save observations.")},document.getElementById("obsCancelBtn").onclick=()=>p.close(),p.showModal()}function B(t){const e=document.getElementById("obsTbody"),n=I.get(t);if(!n)return;const o=n.at?function(t){const e=new Date(t);return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}(n.at):"",i=function(t){if(!t?.length)return"No values";const e=[];for(const n of t)"OpenBottleWeightGrams"===n.code?e.push(`${n.value} g open bottle`):"CountInStoreRoom"===n.code?e.push(`${n.value} in store`):"CountInFridge"===n.code?e.push(`${n.value} in ${"BackBar"===n.location?"back bar":"fridge"}`):e.push(`${n.code}: ${n.value}`);return e.join("; ")}(n.observations);let a=e.querySelector(`tr[data-id='${t}']`);a?(a.children[0].textContent=o,a.children[1].textContent=n.operatorName||"",a.querySelector(".cell--obs").textContent=i):(a=document.createElement("tr"),a.dataset.id=String(t),a.innerHTML=`<td>${m(o)}</td>\n         <td>${m(n.operatorName||"")}</td>\n         <td class="cell--product">${m(n.name)}</td>\n         <td class="cell--obs">${m(i)}</td>\n         <td>\n            <button type="button" class="btn-icon js-edit" title="Edit"><i class="bi bi-pencil-square"></i></button>\n            <button type="button" class="btn-icon text-danger js-remove" title="Remove"><i class="bi bi-trash"></i></button>\n         </td>`,e.appendChild(a)),a.querySelector(".js-edit").onclick=()=>{$(n.stockItemId,n.name,n.division,n.unit)},a.querySelector(".js-remove").onclick=async()=>{const t=await fetch(((t,e)=>`/stocktake/observe/${t}?division=${encodeURIComponent(e)}`)(n.stockItemId,n.division),{method:"DELETE"});if(!t.ok)return void alert("Failed to remove.");I.delete(n.stockItemId),a.remove();const e=E(n.stockItemId);e&&e.classList.remove("tile--partial","tile--complete"),document.getElementById("observationsSection").hidden=0===I.size}}var L;L=async()=>{Array.from(document.querySelectorAll("#operatorTiles .tile")).forEach(e=>{e.addEventListener("click",async()=>{const n=e.dataset.opid,o=new FormData;o.append("id",n),(await fetch("/stocktake/select-operator",{method:"POST",body:o})).ok&&(s(t,n,365),l(),document.getElementById("operatorModal").close(),y())})}),y(),function(){setInterval(()=>{if(c(t)&&u()){r(t),r(e),y();const n=document.getElementById("obsModal");n?.open&&n.close(),b()}},15e3);const n=()=>{c(t)&&l()};document.addEventListener("click",n,{capture:!0}),document.addEventListener("keydown",n,{capture:!0}),document.addEventListener("pointerdown",n,{capture:!0})}(),await async function(){if(window.signalR&&window.signalR.HubConnectionBuilder){f=(new signalR.HubConnectionBuilder).withUrl("/hubs/stocktake").withAutomaticReconnect().build(),f.on("OperatorSelected",e=>{const n=e.colorHex||"#cccccc",o=document.getElementById("operatorStatus");o.innerHTML=`<div class="tile tile--op" style="background:${n};"><span class="tile__name">${m(e.name)}</span></div>`,o.querySelector(".tile--op").addEventListener("click",b),s(t,e.id,365),l()}),f.on("ObservationUpserted",t=>{g&&t.division===g.division&&(I.set(t.stockItemId,t),B(t.stockItemId),C(t.stockItemId,t),document.getElementById("observationsSection").hidden=0===I.size)}),f.on("ObservationRemoved",({stockItemId:t,division:e})=>{if(!g||e!==g.division)return;I.delete(t);const n=document.querySelector(`#obsTbody tr[data-id='${t}']`);n&&n.remove();const o=E(t);o&&o.classList.remove("tile--partial","tile--complete"),document.getElementById("observationsSection").hidden=0===I.size});try{await f.start()}catch{}}}(),v=await async function(){const t=await fetch("/stocktake/products",{headers:{accept:"application/json"}});return t.ok?await t.json():[]}(),function(t){const e=document.getElementById("divisionTiles");e.innerHTML="";const n=[...t].map(t=>({...t,_avg:k(t.products)})).sort((t,e)=>e._avg-t._avg);for(const t of n){const n=document.createElement("div");n.className=`tile cat-${p(t.division)}`,n.dataset.division=t.division,n.innerHTML=`<div class="tile__name">${m(t.division)}</div><small class="tile__division">${Math.round(t._avg)} days</small>`,n.addEventListener("click",()=>h(t)),e.appendChild(n)}}(v),c(t)&&l()},"loading"!==document.readyState?L():document.addEventListener("DOMContentLoaded",L)})();