(()=>{"use strict";const e="wastage_operator_id",t={"WINES|BOTTLE":[{code:"CountInStoreRoom",label:"Count (store)",loc:"Store",step:1},{code:"CountInFridge",label:"Count (fridge)",loc:"Fridge",step:1},{code:"OpenBottleWeightGrams",label:"Open bottle weight (g)",loc:"Bar",step:1}],"MINERALS|BOTTLE":[{code:"CountInStoreRoom",label:"Count (store)",loc:"Store",step:1},{code:"CountInFridge",label:"Count (fridge)",loc:"Fridge",step:1}],"SNACKS|EACH":[{code:"CountInStoreRoom",label:"Count",loc:"Store",step:1}],"BEER CANS|CAN":[{code:"CountInStoreRoom",label:"Count (store)",loc:"Store",step:1},{code:"CountInFridge",label:"Count (fridge)",loc:"Fridge",step:1}]};function o(e){const t=("; "+document.cookie).split("; "+e+"=");return 2===t.length?t.pop().split(";").shift():null}function n(e){return String(e||"").toLowerCase().replace(/\s+/g,"-").replace(/\//g,"-")}function c(e){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}let s=[],d=null;const i=new Map;function a(){const t=o(e),n=document.getElementById("operatorStatus");if(!t)return n.innerHTML='<span class="muted">No operator selected.</span>',void l();const c=document.querySelector(`#operatorTiles .tile[data-opid='${t}']`);if(!c)return document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`,n.innerHTML='<span class="muted">No operator selected.</span>',void l();const s=c.dataset.color||"#cccccc";n.innerHTML=`<div class="tile tile--op" style="background:${s};"><span class="tile__name">${c.textContent.trim()}</span></div>`,n.querySelector(".tile--op").addEventListener("click",l)}function l(){const e=document.getElementById("operatorModal");e.addEventListener("cancel",e=>e.preventDefault(),{once:!0}),e.showModal()}function r(e){if(!e?.length)return 9999;let t=0;for(const o of e)t+=o.daysSinceLastStockTake??9999;return t/e.length}function u(e){d=e,document.getElementById("divisionTitle").textContent=e.division,document.getElementById("divisionAge").textContent=`${Math.round(r(e.products))} days on average`,p(e.products,e.division),document.getElementById("productsSection").hidden=!1}function m(e){return i.has(e)}function p(e,t){const o=document.getElementById("productTiles");o.innerHTML="";for(const s of e){const e=document.createElement("div"),d=m(s.stockItemId);e.className=`tile cat-${n(t)} ${d?"tile--done":""}`,e.dataset.stockItemId=s.stockItemId,e.dataset.name=s.name||"",e.dataset.unit=s.unit||"",e.dataset.division=t||"",e.innerHTML=`<div class="tile__name">${c(s.name)}</div><small class="tile__division">${c(s.unit||"")}</small>`,e.addEventListener("click",()=>v(s.stockItemId,s.name,t,s.unit)),o.appendChild(e)}}function v(e,o,n,s){const d=document.getElementById("obsModal"),a=document.getElementById("obsTitle"),l=document.getElementById("obsFields");a.textContent=`Record observations: ${o}`;const r=i.get(e)?.observations||[],u=function(e,o){const n=`${(e||"").toUpperCase()}|${(o||"").toUpperCase()}`;return t[n]||[{code:"CountInStoreRoom",label:"Count",loc:"Store",step:1}]}(n,s);!function(e,t,o){e.innerHTML="";for(const n of t){const t=document.createElement("div");t.className="obs-field";const s=o?.find(e=>e.code===n.code)?.value??"";t.innerHTML=`<label>${c(n.label)}</label><input type="number" step="${n.step}" min="0" data-code="${n.code}" data-location="${n.loc}" value="${s}">`,e.appendChild(t)}}(l,u,r);const m=()=>{const t=Array.from(l.querySelectorAll("input[data-code]")),a=[];for(const e of t){const t=parseFloat(e.value||"0");t>0&&a.push({code:e.getAttribute("data-code"),location:e.getAttribute("data-location"),value:t})}i.set(e,{stockItemId:e,name:o,division:n,unit:s,observations:a}),function(e){const t=document.getElementById("obsTbody"),o=i.get(e);if(!o)return;let n=t.querySelector(`tr[data-id='${e}']`);const s=function(e){if(!e?.length)return"No values";const t=[];for(const o of e)"OpenBottleWeightGrams"===o.code?t.push(`${o.value} g open bottle`):"CountInStoreRoom"===o.code?t.push(`${o.value} in store`):"CountInFridge"===o.code?t.push(`${o.value} in fridge`):t.push(`${o.code}: ${o.value}`);return t.join("; ")}(o.observations);n?n.querySelector(".cell--obs").textContent=s:(n=document.createElement("tr"),n.dataset.id=String(e),n.innerHTML=`<td class="cell--product">${c(o.name)}</td>\n         <td class="cell--obs">${c(s)}</td>\n         <td>\n            <button type="button" class="btn btn-link p-0 js-edit">Edit</button>\n            <button type="button" class="btn btn-link text-danger p-0 js-remove">Remove</button>\n         </td>`,t.appendChild(n));n.querySelector(".js-edit").addEventListener("click",()=>{v(o.stockItemId,o.name,o.division,o.unit)}),n.querySelector(".js-remove").addEventListener("click",()=>{i.delete(o.stockItemId),n.remove();const e=Array.from(document.querySelectorAll(".tiles--products .tile")).find(e=>parseInt(e.dataset.stockItemId,10)===o.stockItemId);e&&e.classList.remove("tile--done"),document.getElementById("observationsSection").hidden=0===i.size})}(e),function(e){const t=document.querySelector(`.tiles--products .tile[data-stock-item-id='${e}']`),o=Array.from(document.querySelectorAll(".tiles--products .tile")).find(t=>parseInt(t.dataset.stockItemId,10)===e),n=t||o;n&&n.classList.add("tile--done")}(e),document.getElementById("observationsSection").hidden=0===i.size,d.close(),d.removeEventListener("close",p),document.getElementById("obsSaveBtn").removeEventListener("click",m),document.getElementById("obsCancelBtn").removeEventListener("click",p)},p=()=>{d.close(),d.removeEventListener("close",p),document.getElementById("obsSaveBtn").removeEventListener("click",m),document.getElementById("obsCancelBtn").removeEventListener("click",p)};document.getElementById("obsSaveBtn").addEventListener("click",m),document.getElementById("obsCancelBtn").addEventListener("click",p),d.addEventListener("close",p,{once:!0}),d.showModal()}async function g(){if(!o(e))return void l();const t=[];for(const[,e]of i)for(const o of e.observations)t.push({stockItemId:e.stockItemId,code:o.code,location:o.location,value:o.value});if(0===t.length)return void alert("Add at least one observation.");const n={timestamp:(new Date).toISOString(),observations:t},c=document.getElementById("commitBtn");c.disabled=!0;const s=c.textContent;c.textContent="Committingâ€¦";try{if(!(await fetch("/stocktake/commit",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(n)})).ok)return void alert("Failed to commit.");alert("Stock take committed."),i.clear(),document.getElementById("obsTbody").innerHTML="",document.getElementById("observationsSection").hidden=!0,d&&p(d.products,d.division)}finally{c.disabled=!1,c.textContent=s}}var I;I=async()=>{Array.from(document.querySelectorAll("#operatorTiles .tile")).forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset.opid,o=new FormData;o.append("id",t),(await fetch("/stocktake/select-operator",{method:"POST",body:o})).ok&&(document.getElementById("operatorModal").close(),a())})}),a(),s=await async function(){const e=await fetch("/stocktake/products",{headers:{accept:"application/json"}});return e.ok?await e.json():[]}(),function(e){const t=document.getElementById("divisionTiles");t.innerHTML="";const o=[...e].map(e=>({...e,_avg:r(e.products)})).sort((e,t)=>t._avg-e._avg);for(const e of o){const o=document.createElement("div");o.className=`tile cat-${n(e.division)}`,o.dataset.division=e.division,o.innerHTML=`<div class="tile__name">${c(e.division)}</div><small class="tile__division">${Math.round(e._avg)} days</small>`,o.addEventListener("click",()=>u(e)),t.appendChild(o)}}(s),document.getElementById("commitBtn").addEventListener("click",g)},"loading"!==document.readyState?I():document.addEventListener("DOMContentLoaded",I)})();