(()=>{"use strict";const t="wastage_operator_id",e="wastage_operator_ts",n={"WINES|BOTTLE":["CountInStoreRoom","CountInLoungeBar","OpenBottleWeightGrams@Lounge","CountInColtBar","OpenBottleWeightGrams@Colt"],"MINERALS|BOTTLE":["CountInStoreRoom","CountInLoungeBar","CountInColtBar"],"SNACKS|EACH":["CountInStoreRoom","CountInLoungeBar","CountInColtBar"],"BEER CANS|CAN":["CountInStoreRoom","CountInLoungeBar","CountInColtBar"],"DRAUGHT BEER|PINT":["CountInCellar","KegWeightGrams@Cellar"],"*|*":["CountInStoreRoom","CountInLoungeBar","CountInColtBar"]};function o(t,e){const o=`${(t||"").toUpperCase()}|${(e||"").toUpperCase()}`;return n[o]||n["*|*"]}function a(t){const[e,n]=String(t).split("@");return{code:e,location:n||null}}function i(t){const e=("; "+document.cookie).split("; "+t+"=");return 2===e.length?e.pop().split(";").shift():null}function s(t,e,n){let o="";if("number"==typeof n){const t=new Date;t.setTime(t.getTime()+24*n*60*60*1e3),o="; expires="+t.toUTCString()}document.cookie=`${t}=${e}; path=/; SameSite=Lax${o}`}function c(t){document.cookie=`${t}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax`}function r(){return Date.now()}function l(){s(e,String(r()),365)}function d(){const t=parseInt(i(e)||"0",10);return!t||r()-t>9e5}function u(t){return String(t??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function m(t){return String(t||"").toLowerCase().replace(/\s+/g,"-").replace(/\//g,"-")}function p(t){const e=new URL(window.location.href).searchParams.get(t);return null===e?null:e}function g(t){const e=function(t){let e=1779033703^t.length;for(let n=0;n<t.length;n++)e=Math.imul(e^t.charCodeAt(n),3432918353),e=e<<13|e>>>19;return function(){return e=Math.imul(e^e>>>16,2246822507),e=Math.imul(e^e>>>13,3266489909),e^=e>>>16,e>>>0}}(t);return n=e(),o=e(),a=e(),i=e(),function(){let t=(n>>>=0)+(o>>>=0)|0;return n=o^o>>>9,o=(a>>>=0)+(a<<3)|0,t=t+(i=(i>>>=0)+1|0)|0,a=(a=a<<21|a>>>11)+t|0,(t>>>0)/4294967296};var n,o,a,i}function f(t,e){const n=function(t,e){const n=t.slice();for(let t=n.length-1;t>0;t--){const o=Math.floor(e()*(t+1));[n[t],n[o]]=[n[o],n[t]]}return n}(t,g(`stocktake:${(new Date).toISOString().slice(0,10)}`));return n.slice(0,Math.min(e,n.length))}let b=[],v=null;const h=new Map;let C=null;function I(){const n=i(t),o=document.getElementById("operatorStatus");if(!n)return o.innerHTML='<span class="muted">No operator selected.</span>',void y();const a=document.querySelector(`#operatorTiles .tile[data-opid='${n}']`);if(!a)return c(t),c(e),o.innerHTML='<span class="muted">No operator selected.</span>',void y();const s=a.dataset.color||"#cccccc";o.innerHTML=`<div class="tile tile--op" style="background:${s};"><span class="tile__name">${u(a.textContent.trim())}</span></div>`,o.querySelector(".tile--op").addEventListener("click",y)}function y(){const t=document.getElementById("operatorModal");t.addEventListener("cancel",t=>t.preventDefault(),{once:!0}),t.showModal()}async function k(t){const e=await fetch((n=t,`/stocktake/draft?division=${encodeURIComponent(n)}`));var n;if(!e.ok)return void h.clear();const o=await e.json();h.clear();for(const t of o)h.set(t.stockItemId,t)}function $(t){if(!t?.length)return 9999;let e=0;for(const n of t)e+=n.daysSinceLastStockTake??9999;return e/t.length}async function S(t){v=t,document.getElementById("divisionTitle").textContent=t.division,await k(t.division),function(){const t=document.getElementById("productTiles");t.innerHTML="";const e=v?.division||"",n=v?.products||[];for(const o of n){const n=h.get(o.stockItemId),a=document.createElement("div");a.className="tile",a.dataset.stockItemId=o.stockItemId,a.dataset.name=o.name||"",a.dataset.unit=o.unit||"",a.dataset.division=e,a.innerHTML=`<div class="tile__name">${u(o.name)}</div><small class="tile__division">${u(o.unit||"")}</small>`,a.addEventListener("click",()=>M(o.stockItemId,o.name,e,o.unit)),t.appendChild(a),n&&w(o.stockItemId,n)}}(),function(){document.getElementById("obsTbody").innerHTML="";for(const[,t]of h)N(t.stockItemId)}(),document.getElementById("productsSection").hidden=!1,document.getElementById("observationsSection").hidden=0===h.size}function E(t){return Array.from(document.querySelectorAll(".tiles--products .tile")).find(e=>parseInt(e.dataset.stockItemId,10)===t)||null}function B(t){const e=t.observations||[];return new Set(e.map(t=>`${t.code}@${t.location||""}`))}function L(t){const e=function(t){return o(t.division,t.unit).map(t=>a(t))}(t),n=B(t);let i=0;for(const t of e){const e=`${t.code}@${t.location||""}`;n.has(e)||i++}return i}function w(t,e){const n=E(t);if(!n)return;n.classList.remove("tile--partial","tile--complete"),n.querySelector(".tile__badge")?.remove();if(!((e.observations||[]).length>0))return;const o=L(e);if(0===o)n.classList.add("tile--complete");else{n.classList.add("tile--partial");const t=document.createElement("span");t.className="tile__badge",t.textContent=`${o} left`,n.appendChild(t)}}function T(t,e,n,o){t.innerHTML="";const a=document.createElement("div");a.className="obs-progress",t.appendChild(a);const i=document.createElement("div");i.className="obs-hint",i.textContent="Blank = not observed. 0 = none found.",t.appendChild(i);const s=document.createElement("div");s.className="obs-groups",t.appendChild(s);const c=new Map;(n||[]).forEach(t=>{const e=`${t.code}@${t.location||""}`;c.set(e,t.value)});const r=function(t){const e=String(t||"").trim().toLowerCase();return e?"bottle"===e?"bottles":"can"===e?"cans":"each"===e?"items":"pint"===e?"pints":e.endsWith("s")?e:e+"s":"items"}(o);function l(t){const[e,n]=String(t).split("@"),o=n||null,a=`Number of unopened ${r}`;return"CountInStoreRoom"===e?{group:"Store Room",label:a,key:`${e}@`}:"CountInColtBar"===e?{group:"Colt bar",label:a,key:`${e}@`}:"CountInLoungeBar"===e?{group:"Lounge bar",label:a,key:`${e}@`}:"CountInCellar"===e?{group:"Cellar",label:"Count",key:`${e}@`}:"OpenBottleWeightGrams"===e&&"Colt"===o?{group:"Colt bar",label:"Total weight of open bottles (g)",key:"OpenBottleWeightGrams@Colt"}:"OpenBottleWeightGrams"===e&&"Lounge"===o?{group:"Lounge bar",label:"Total weight of open bottles (g)",key:"OpenBottleWeightGrams@Lounge"}:"KegWeightGrams"===e&&"Cellar"===o?{group:"Cellar",label:"Weight of Keg being used (g)",key:"KegWeightGrams@Cellar"}:{group:"Other",label:e+(o?` (${o})`:""),key:`${e}@${o||""}`}}const d=["Store Room","Colt bar","Lounge bar","Cellar","Other"],m=new Map(d.map(t=>[t,[]]));for(const t of e){const e=l(t);m.has(e.group)||m.set(e.group,[]),m.get(e.group).push(e)}for(const t of d){const e=m.get(t)||[];if(!e.length)continue;const n=document.createElement("section");n.className="obs-group";const o=document.createElement("h4");o.className="obs-group__title",o.textContent=t,n.appendChild(o);const a=document.createElement("div");a.className="obs-row",n.appendChild(a);for(const t of e){const e=c.has(t.key)?c.get(t.key):"",n=document.createElement("div");n.className="obs-field",n.innerHTML=`<label class="obs-label">${u(t.label)}</label>\n                 <div class="obs-input-row">\n                   <input type="number" step="1" min="0"\n                          class="obs-input"\n                          data-token="${u(t.key)}"\n                          data-code="${u(t.key.split("@")[0])}"\n                          ${t.key.includes("@")&&!t.key.endsWith("@")?`data-location="${u(t.key.split("@")[1])}"`:""}\n                          value="${""!==e?String(e):""}">\n                   <button type="button" class="btn-quick-zero" data-for="${u(t.key)}" aria-label="Set to none">None</button>\n                 </div>`,a.appendChild(n)}s.appendChild(n)}const p=document.createElement("div");p.className="obs-note",p.textContent="You can record some values now and come back later to complete this product. Observations should be completed before the end of the day.";const g=document.querySelector("#obsModal footer.actions");g.classList.add("obs-footer"),g.querySelector(".obs-note")?.remove();let f=g.querySelector(".obs-btns");if(!f){const t=document.getElementById("obsSaveBtn"),e=document.getElementById("obsCancelBtn");f=document.createElement("div"),f.className="obs-btns",g.appendChild(f),f.appendChild(t),f.appendChild(e)}function b(){const e=Array.from(t.querySelectorAll("input[data-code]")),n=e.length,o=e.filter(t=>""!==t.value).length,i=o===n;a.textContent=`${o} of ${n} observations recorded${i?" — Complete":""}`}g.prepend(p),t.addEventListener("input",t=>{t.target&&t.target.matches("input[data-code]")&&b()}),t.addEventListener("click",e=>{const n=e.target.closest(".btn-quick-zero");if(!n)return;const o=n.dataset.for,a=Array.from(t.querySelectorAll("input[data-code]")).find(t=>`${t.getAttribute("data-code")}@${t.getAttribute("data-location")||""}`===o);a&&(a.value="0",a.dispatchEvent(new Event("input",{bubbles:!0})),a.focus(),a.select())}),b()}function M(n,a,s,r){const l=document.getElementById("obsModal"),u=document.getElementById("obsTitle"),m=document.getElementById("obsFields");u.textContent=`Record observations: ${a}`;const p=h.get(n)?.observations||[],g=o(s,r);T(m,g,p,r);document.getElementById("obsSaveBtn").onclick=async()=>{const o=Array.from(m.querySelectorAll("input[data-code]")),u=[];for(const t of o){const e=t.value;if(""===e)continue;const o=parseFloat(e);!isFinite(o)||o<0||u.push({stockItemId:n,code:t.getAttribute("data-code"),location:t.getAttribute("data-location"),value:o})}const p=i(t);if(!p||d())return c(t),c(e),I(),l.close(),void y();const g={stockItemId:n,name:a,division:s,unit:r,operatorId:p,operatorName:document.querySelector("#operatorStatus .tile--op .tile__name")?.textContent?.trim()||"",at:(new Date).toISOString(),observations:u};(await fetch("/stocktake/observe",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(g)})).ok?(h.set(n,{...g}),N(n),w(n,g),document.getElementById("observationsSection").hidden=0===h.size,l.close()):alert("Failed to save observations.")},document.getElementById("obsCancelBtn").onclick=()=>l.close(),l.showModal()}function _(t){const e=o(t.division,t.unit),n=B(t),i=new Map((t.observations||[]).map(t=>[`${t.code}@${t.location||""}`,t.value])),s=[];function c(t,e){const{code:o,location:c}=a(t),r=`${o}@${c||""}`;n.has(r)?e(i.get(r)):s.push(`${function(t){const{code:e,location:n}=a(t);return"CountInLoungeBar"===e?"Count (Lounge bar)":"CountInColtBar"===e?"Count (Colt bar)":"CountInStoreRoom"===e?"Count (store room)":"CountInCellar"===e?"Count (cellar)":"OpenBottleWeightGrams"===e?n?`Total weight of open bottles (g, ${n})`:"Total weight of open bottles (g)":"KegWeightGrams"===e?"Weight of Keg in use (g)":e}(t)}: not observed`)}for(const t of e){const{code:e,location:n}=a(t);c(t,"CountInLoungeBar"===e?t=>s.push(`${t} in Lounge bar`):"CountInColtBar"===e?t=>s.push(`${t} in Colt bar`):"CountInStoreRoom"===e?t=>s.push(`${t} in store room`):"CountInCellar"===e?t=>s.push(`${t} in cellar`):"OpenBottleWeightGrams"===e?t=>s.push(`${t} g open bottle (${n})`):"KegWeightGrams"===e?t=>s.push(`${t} g keg weight`):t=>s.push(`${e}${n?` @ ${n}`:""}: ${t}`))}return s.join("; ")}function N(t){const e=document.getElementById("obsTbody"),n=h.get(t);if(!n)return;const o=n.at?function(t){const e=new Date(t);return`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}(n.at):"",a=L(n),i=`${0===a?"Complete":`Incomplete: ${a} remaining`} — ${_(n)}`;let s=e.querySelector(`tr[data-id='${t}']`);s?(s.children[0].textContent=o,s.children[1].textContent=n.operatorName||"",s.querySelector(".cell--obs").textContent=i):(s=document.createElement("tr"),s.dataset.id=String(t),s.innerHTML=`<td>${u(o)}</td>\n                 <td>${u(n.operatorName||"")}</td>\n                 <td class="cell--product">${u(n.name)}</td>\n                 <td class="cell--obs">${u(i)}</td>\n                 <td>\n                    <button type="button" class="btn-icon js-edit" title="Edit"><i class="bi bi-pencil-square"></i></button>\n                    <button type="button" class="btn-icon text-danger js-remove" title="Remove"><i class="bi bi-trash"></i></button>\n                 </td>`,e.appendChild(s)),s.querySelector(".js-edit").onclick=()=>{M(n.stockItemId,n.name,n.division,n.unit)},s.querySelector(".js-remove").onclick=async()=>{const t=await fetch(((t,e)=>`/stocktake/observe/${t}?division=${encodeURIComponent(e)}`)(n.stockItemId,n.division),{method:"DELETE"});if(!t.ok)return void alert("Failed to remove.");h.delete(n.stockItemId),s.remove();const e=E(n.stockItemId);e&&(e.classList.remove("tile--partial","tile--complete"),e.querySelector(".tile__badge")?.remove()),document.getElementById("observationsSection").hidden=0===h.size}}var R;R=async()=>{Array.from(document.querySelectorAll("#operatorTiles .tile")).forEach(e=>{e.addEventListener("click",async()=>{const n=e.dataset.opid,o=new FormData;o.append("id",n),(await fetch("/stocktake/select-operator",{method:"POST",body:o})).ok&&(s(t,n,365),l(),document.getElementById("operatorModal").close(),I())})}),I(),function(){setInterval(()=>{if(i(t)&&d()){c(t),c(e),I();const n=document.getElementById("obsModal");n?.open&&n.close(),y()}},15e3);const n=()=>{i(t)&&l()};document.addEventListener("click",n,{capture:!0}),document.addEventListener("keydown",n,{capture:!0}),document.addEventListener("pointerdown",n,{capture:!0})}(),await async function(){if(window.signalR&&window.signalR.HubConnectionBuilder){C=(new signalR.HubConnectionBuilder).withUrl("/hubs/stocktake").withAutomaticReconnect().build(),C.on("OperatorSelected",e=>{const n=e.colorHex||"#cccccc",o=document.getElementById("operatorStatus");o.innerHTML=`<div class="tile tile--op" style="background:${n};"><span class="tile__name">${u(e.name)}</span></div>`,o.querySelector(".tile--op").addEventListener("click",y),s(t,e.id,365),l()}),C.on("ObservationUpserted",t=>{v&&t.division===v.division&&(h.set(t.stockItemId,t),N(t.stockItemId),w(t.stockItemId,t),document.getElementById("observationsSection").hidden=0===h.size)}),C.on("ObservationRemoved",({stockItemId:t,division:e})=>{if(!v||e!==v.division)return;h.delete(t);const n=document.querySelector(`#obsTbody tr[data-id='${t}']`);n&&n.remove();const o=E(t);o&&(o.classList.remove("tile--partial","tile--complete"),o.querySelector(".tile__badge")?.remove()),document.getElementById("observationsSection").hidden=0===h.size});try{await C.start()}catch{}}}(),b=await async function(){const t=await fetch("/stocktake/products",{headers:{accept:"application/json"}});return t.ok?await t.json():[]}();const n=null!==p("alldivisions"),o=parseInt(p("count")||"2",10),a=n?b:f(b,isFinite(o)&&o>0?o:2),r=document.getElementById("divisionTiles");if(!n){const t=document.createElement("div");t.className="muted",t.style.marginBottom=".5rem",t.textContent=`Showing ${a.length} of ${b.length} divisions today. Add ?alldivisions to the URL to show all.`,r.parentElement.insertBefore(t,r)}!function(t){const e=document.getElementById("divisionTiles");e.innerHTML="";const n=[...t].map(t=>({...t,_avg:$(t.products)})).sort((t,e)=>e._avg-t._avg);for(const t of n){const n=document.createElement("div");n.className=`tile cat-${m(t.division)}`,n.dataset.division=t.division,n.innerHTML=`<div class="tile__name">${u(t.division)}</div><small class="tile__division">${Math.round(t._avg)} days</small>`,n.addEventListener("click",()=>S(t)),e.appendChild(n)}}(a),i(t)&&l()},"loading"!==document.readyState?R():document.addEventListener("DOMContentLoaded",R)})();