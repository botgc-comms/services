@model BOTGC.MemberPortal.Models.VouchersPageViewModel

@{
    ViewData["Title"] = "My Vouchers";
    Layout = "_SubpageLayout";
    ViewData["BackHref"] = "/";
    ViewData["BackLabel"] = "Back to dashboard";

    var tab = (Context.Request.Query["tab"].ToString() ?? "active").ToLowerInvariant();
    if (tab is not ("active" or "used" or "expired"))
    {
        tab = "active";
    }

    var filterVm = new BOTGC.MemberPortal.Models.FilterBarViewModel
    {
        AriaLabel = "Voucher filters",
        CurrentValue = tab,
        Options = new()
        {
            new() { Value = "active", Label = "Active", Href = "/vouchers?tab=active" },
            new() { Value = "used", Label = "Used", Href = "/vouchers?tab=used" },
            new() { Value = "expired", Label = "Expired", Href = "/vouchers?tab=expired" },
        }
    };
}

@section PageHeader
{
    <h1 class="learning__title">My vouchers</h1>
}

<div class="vouchers">
    @await Html.PartialAsync("_FilterBar", filterVm)

    <section class="vouchers__panel @(tab == "active" ? "is-active" : "")" data-panel="active" aria-label="Active vouchers">
        @if (Model.Active.Count == 0)
        {
            <div class="vouchers__empty">
                <img class="vouchers__empty-img" src="/img/vouchers/gift.png" alt="" />
                <h2 class="vouchers__empty-title">No vouchers yet</h2>
                <p class="vouchers__empty-subtitle">Complete activities to earn rewards</p>
                <a class="vouchers__cta app-link" href="/activities">View Activities</a>
            </div>
        }
        else
        {
            <ul class="vlist">
                @foreach (var v in Model.Active)
                {
                    <li class="vlist__item">
                        <a class="vcard app-link" href="/vouchers/@v.Id">
                            <div class="vcard__date">
                                <div class="vcard__day">@DateTime.UtcNow.Day</div>
                                <div class="vcard__month">@DateTime.UtcNow.ToString("MMMM")</div>
                            </div>

                            <div class="vcard__main">
                                <div class="vcard__title">@v.TypeTitle</div>
                                <div class="vcard__subtitle">@v.TypeDescription</div>
                                <span class="vcard__btn">View Details</span>
                            </div>
                        </a>
                    </li>
                }
            </ul>
        }
    </section>

    <section class="vouchers__panel @(tab == "used" ? "is-active" : "")" data-panel="used" aria-label="Used vouchers">
        @if (Model.Used.Count == 0)
        {
            <div class="vouchers__empty">
                <img class="vouchers__empty-img" src="/img/vouchers/gift.png" alt="" />
                <h2 class="vouchers__empty-title">No used vouchers</h2>
                <p class="vouchers__empty-subtitle">Vouchers you’ve spent will appear here</p>
            </div>
        }
        else
        {
            <ul class="vlist">
                @foreach (var v in Model.Used)
                {
                    <li class="vlist__item">
                        <a class="vcard app-link" href="/vouchers/@v.Id">
                            <div class="vcard__date vcard__date--muted">
                                <div class="vcard__day">@DateTime.UtcNow.Day</div>
                                <div class="vcard__month">@DateTime.UtcNow.ToString("MMMM")</div>
                            </div>

                            <div class="vcard__main">
                                <div class="vcard__title">@v.TypeTitle</div>
                                <div class="vcard__subtitle">@v.TypeDescription</div>
                                <span class="vcard__btn">View Details</span>
                            </div>
                        </a>
                    </li>
                }
            </ul>
        }
    </section>

    <section class="vouchers__panel @(tab == "expired" ? "is-active" : "")" data-panel="expired" aria-label="Expired vouchers">
        @if (Model.Expired.Count == 0)
        {
            <div class="vouchers__empty">
                <img class="vouchers__empty-img" src="/img/vouchers/gift.png" alt="" />
                <h2 class="vouchers__empty-title">No expired vouchers</h2>
                <p class="vouchers__empty-subtitle">Expired vouchers will appear here</p>
            </div>
        }
        else
        {
            <ul class="vlist">
                @foreach (var v in Model.Expired)
                {
                    <li class="vlist__item">
                        <a class="vcard app-link" href="/vouchers/@v.Id">
                            <div class="vcard__date vcard__date--muted">
                                <div class="vcard__day">@DateTime.UtcNow.Day</div>
                                <div class="vcard__month">@DateTime.UtcNow.ToString("MMMM")</div>
                            </div>

                            <div class="vcard__main">
                                <div class="vcard__title">@v.TypeTitle</div>
                                <div class="vcard__subtitle">@v.TypeDescription</div>
                                <span class="vcard__btn">View Details</span>
                            </div>
                        </a>
                    </li>
                }
            </ul>
        }
    </section>
</div>

<script>
    (() => {
        const tabs = Array.from(document.querySelectorAll(".filterbar--segmented .filterbar__item"));
        const panels = Array.from(document.querySelectorAll(".vouchers__panel"));

        const setQuery = (key) => {
            const url = new URL(window.location.href);
            url.searchParams.set("tab", key);
            window.history.replaceState({}, "", url);
        };

        const activate = (key) => {
            tabs.forEach(t => {
                const href = t.getAttribute("href") || "";
                const u = new URL(href, window.location.origin);
                const v = (u.searchParams.get("tab") || u.searchParams.get("filter") || u.pathname.split("/").pop() || "").toLowerCase();
                const isActive = v === key;
                t.classList.toggle("filterbar__item--active", isActive);
                if (isActive) t.setAttribute("aria-current", "page");
                else t.removeAttribute("aria-current");
            });

            panels.forEach(p => p.classList.toggle("is-active", p.dataset.panel === key));
            setQuery(key);
        };

        const readTab = () => {
            const url = new URL(window.location.href);
            const t = (url.searchParams.get("tab") || "active").toLowerCase();
            return (t === "active" || t === "used" || t === "expired") ? t : "active";
        };

        activate(readTab());

        tabs.forEach(t => {
            t.addEventListener("click", (e) => {
                e.preventDefault();
                const href = t.getAttribute("href") || "";
                const u = new URL(href, window.location.origin);
                const key = (u.searchParams.get("tab") || "active").toLowerCase();
                activate(key);
            });
        });
    })();
</script>
